
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Онлайн-конструктор портфолио{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* Убрать все отступы у html и body */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            min-height: 100%;
        }
        
        /* Плавные переходы между страницами */
        html {
            scroll-behavior: smooth;
        }
        
        /* Анимация появления контента */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .page-transition {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Плавные переходы для навигации */
        nav a {
            transition: all 0.3s ease;
        }
        
        /* Плавное появление секций */
        .fade-in-section {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }
        
        .fade-in-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Перенос текста для всех элементов */
        * {
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        /* Предотвращение горизонтального скролла */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }
        
        /* Перенос текста для текстовых элементов */
        p, span, div, h1, h2, h3, h4, h5, h6, a, li, td, th {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Контейнеры не должны выходить за пределы экрана */
        .container, .max-w-7xl, .max-w-6xl, .max-w-5xl, .max-w-4xl, .max-w-3xl, .max-w-2xl, .max-w-xl, .max-w-lg, .max-w-md, .max-w-sm {
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Выравнивание изображений */
        img {
            object-fit: cover;
            object-position: center;
            display: block;
            vertical-align: middle;
            max-width: 100%;
            height: auto;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gray-50 flex flex-col" style="opacity: 0; transition: opacity 0.5s ease-in; margin: 0 !important; padding: 0 !important;">
    {% if user.is_authenticated %}
    <nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50" style="margin: 0 !important; padding: 0 !important; top: 0 !important; height: 56px;">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full">
            <div class="flex justify-between items-center h-full">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center">
                        <h1 class="text-xl font-bold text-indigo-600">Portfolio Builder</h1>
                    </div>
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="/" 
                           class="{% if request.path == '/' %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:scale-105">
                            Главное
                        </a>
                        <a href="/about/" 
                           class="{% if request.path == '/about/' %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:scale-105">
                            О нас
                        </a>
                        <a href="/create/" 
                           class="{% if request.path == '/create/' %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:scale-105">
                            Сделать портфолио
                        </a>
                        <a href="/portfolios/" 
                           class="{% if request.path == '/portfolios/' %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:scale-105">
                            Мои портфолио
                        </a>
                        {% if user.is_admin %}
                        <a href="/admin-panel/" 
                           class="{% if '/admin-panel/' in request.path %}border-indigo-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-all duration-300 hover:scale-105">
                            Админ-панель
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center space-x-4" x-data="profileData">
                    <!-- Профиль с выпадающим меню -->
                    <div class="relative">
                        <button @click="profileMenuOpen = !profileMenuOpen" class="flex items-center space-x-3 text-gray-700 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-full p-1">
                            <div class="flex items-center space-x-2">
                                {% if user.avatar %}
                                <img id="nav-avatar" src="{{ user.avatar.url }}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-200 hover:border-indigo-400 transition-colors">
                                {% else %}
                                <div id="nav-avatar-placeholder" class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center border-2 border-indigo-200 hover:border-indigo-400 transition-colors">
                                    <span id="nav-username-initial" class="text-indigo-600 text-sm font-semibold">{{ user.username|first|upper }}</span>
                                </div>
                                {% endif %}
                                <span id="nav-username" class="hidden md:block text-sm font-medium">{{ user.username|default:user.email }}</span>
                                <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </button>
                        
                        <!-- Выпадающее меню -->
                        <div x-show="profileMenuOpen" 
                             x-transition:enter="transition ease-out duration-100"
                             x-transition:enter-start="transform opacity-0 scale-95"
                             x-transition:enter-end="transform opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75"
                             x-transition:leave-start="transform opacity-100 scale-100"
                             x-transition:leave-end="transform opacity-0 scale-95"
                             @click.away="profileMenuOpen = false" 
                             x-cloak
                             class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                            <div class="py-1" role="menu">
                                <!-- Информация о пользователе -->
                                <div class="px-4 py-3 border-b border-gray-200">
                                    <p class="text-sm font-semibold text-gray-900">{{ user.username|default:user.email }}</p>
                                    <p class="text-xs text-gray-500 truncate">{{ user.email }}</p>
                                </div>
                                
                                <!-- Кнопка открытия модального окна настроек -->
                                <button @click="profileMenuOpen = false; profileModalOpen = true" class="w-full flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600" role="menuitem">
                                    <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    Настройки профиля
                                </button>
                                
                                <!-- Разделитель -->
                                <div class="border-t border-gray-200"></div>
                                
                                <!-- Кнопка выхода -->
                                <a href="/auth/logout/" class="flex items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50" role="menuitem">
                                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                                    </svg>
                                    Выход
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Модальное окно настроек профиля -->
                    <div x-show="profileModalOpen" 
                         x-transition:enter="transition ease-out duration-300"
                         x-transition:enter-start="opacity-0"
                         x-transition:enter-end="opacity-100"
                         x-transition:leave="transition ease-in duration-200"
                         x-transition:leave-start="opacity-100"
                         x-transition:leave-end="opacity-0"
                         @click.away="profileModalOpen = false"
                         @keydown.escape.window="profileModalOpen = false"
                         x-cloak
                         class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
                        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                            <!-- Затемнение фона -->
                            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="profileModalOpen = false"></div>
                            
                            <!-- Модальное окно -->
                            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
                                <form id="profile-form" method="post" enctype="multipart/form-data" action="/profile/" class="space-y-6">
                                    {% csrf_token %}
                                    
                                    <!-- Заголовок -->
                                    <div class="bg-white px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                                        <h3 class="text-xl font-bold text-gray-900">Настройки профиля</h3>
                                        <button type="button" @click="profileModalOpen = false" class="text-gray-400 hover:text-gray-500">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Контент модального окна -->
                                    <div class="bg-white px-6 py-4 max-h-[calc(100vh-200px)] overflow-y-auto">
                                        <div id="profile-messages" class="mb-4"></div>
                                        
                                        <!-- Аватар -->
                                        <div class="mb-6">
                                            <label class="block text-sm font-medium text-gray-700 mb-4">Фото профиля</label>
                                            <div class="flex items-center space-x-6">
                                                <div class="flex-shrink-0 relative">
                                                    {% if user.avatar %}
                                                    <img id="modal-avatar-preview" src="{{ user.avatar.url }}" alt="Avatar" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-100">
                                                    {% else %}
                                                    <div id="modal-avatar-preview" class="w-24 h-24 rounded-full bg-indigo-100 flex items-center justify-center border-4 border-indigo-200">
                                                        <span class="text-indigo-600 text-3xl font-bold">{{ user.username|first|upper }}</span>
                                                    </div>
                                                    {% endif %}
                                                    <div id="avatar-loading-indicator" class="hidden absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center">
                                                        <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="flex-1">
                                                    <input type="file" id="modal-avatar-input" name="avatar" accept="image/*" 
                                                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                                                    <p class="mt-2 text-sm text-gray-500">JPG, PNG или GIF. Максимальный размер: 5MB</p>
                                                    <p id="avatar-file-name" class="mt-1 text-sm font-medium text-indigo-600 hidden"></p>
                                                    <p id="avatar-save-hint" class="mt-1 text-xs text-gray-400 hidden">Нажмите "Сохранить изменения" для загрузки фото</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Основная информация -->
                                        <div class="border-t pt-6 mb-6">
                                            <h4 class="text-lg font-bold text-gray-900 mb-4">Основная информация</h4>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div>
                                                    <label for="modal-first-name" class="block text-sm font-medium text-gray-700 mb-2">Имя</label>
                                                    <input type="text" id="modal-first-name" name="first_name" value="{{ user.first_name }}" 
                                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                                <div>
                                                    <label for="modal-last-name" class="block text-sm font-medium text-gray-700 mb-2">Фамилия</label>
                                                    <input type="text" id="modal-last-name" name="last_name" value="{{ user.last_name }}" 
                                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                </div>
                                                <div class="md:col-span-2">
                                                    <label for="modal-username" class="block text-sm font-medium text-gray-700 mb-2">Имя пользователя (никнейм)</label>
                                                    <input type="text" id="modal-username" name="username" value="{{ user.username }}" 
                                                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    <p class="mt-1 text-xs text-gray-500">Ваше уникальное имя пользователя для входа в систему</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Дополнительная информация -->
                                        <div class="border-t pt-6 mb-6">
                                            <h4 class="text-lg font-bold text-gray-900 mb-4">Дополнительная информация</h4>
                                            <div class="space-y-4">
                                                <div>
                                                    <label for="modal-bio" class="block text-sm font-medium text-gray-700 mb-2">О себе</label>
                                                    <textarea id="modal-bio" name="bio" rows="4" 
                                                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">{{ user.bio }}</textarea>
                                                    <p class="mt-1 text-xs text-gray-500">Расскажите о себе (максимум 500 символов)</p>
                                                </div>
                                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <label for="modal-phone" class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                                                        <input type="text" id="modal-phone" name="phone" value="{{ user.phone }}" 
                                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                    <div>
                                                        <label for="modal-website" class="block text-sm font-medium text-gray-700 mb-2">Веб-сайт</label>
                                                        <input type="url" id="modal-website" name="website" value="{{ user.website }}" 
                                                               placeholder="https://example.com"
                                                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Футер с кнопками -->
                                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                                        <button type="button" @click="profileModalOpen = false" 
                                                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                            Отмена
                                        </button>
                                        <button type="submit" id="save-profile-btn"
                                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 shadow-lg">
                                            Сохранить изменения
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <main class="flex-grow page-transition" id="main-content">
        {% block content %}{% endblock %}
    </main>
    
    {% if user.is_authenticated %}
    <footer class="bg-gray-800 text-white mt-auto" id="main-footer">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-lg font-bold mb-4">Portfolio Builder</h3>
                    <p class="text-gray-400 text-sm">Создайте профессиональное портфолио за минуты</p>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Навигация</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="/" class="hover:text-white">Главное</a></li>
                        <li><a href="/about/" class="hover:text-white">О нас</a></li>
                        <li><a href="/create/" class="hover:text-white">Создать портфолио</a></li>
                        <li><a href="/profile/" class="hover:text-white">Настройки</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Помощь</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="/about/" class="hover:text-white">О платформе</a></li>
                        <li><a href="/create/" class="hover:text-white">Как создать портфолио</a></li>
                        {% if user.is_admin %}
                        <li><a href="/admin-panel/" class="hover:text-white">Админ-панель</a></li>
                        {% endif %}
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold mb-4">Контакты</h4>
                    <p class="text-sm text-gray-400">Email: support@portfoliobuilder.com</p>
                    <p class="text-sm text-gray-400 mt-2">© 2026 Portfolio Builder. Все права защищены.</p>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-400">
                <p>Создано с ❤️ для профессионалов</p>
            </div>
        </div>
    </footer>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
    
    <script>
        // Плавное появление при загрузке страницы
        (function() {
            function initPageAnimation() {
                // Плавное появление body
                setTimeout(() => {
                    document.body.style.opacity = '1';
                }, 50);
                
                // Плавное появление секций с небольшой задержкой
                const sections = document.querySelectorAll('.fade-in-section');
                sections.forEach((section, index) => {
                    setTimeout(() => {
                        section.style.opacity = '1';
                        section.style.transform = 'translateY(0)';
                    }, 100 + index * 50);
                });
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPageAnimation);
            } else {
                initPageAnimation();
            }
        })();
    </script>
    
    {% if user.is_authenticated %}
    <script>
        // Инициализация Alpine.js для управления состоянием
        document.addEventListener('alpine:init', () => {
            Alpine.data('profileData', () => ({
                profileMenuOpen: false,
                profileModalOpen: false,
                
                init() {
                    // Слушаем событие закрытия модального окна
                    window.addEventListener('close-profile-modal', () => {
                        this.profileModalOpen = false;
                    });
                    
                                    // Предпросмотр аватара в модальном окне
                                    this.$watch('profileModalOpen', (value) => {
                                        if (value) {
                                            // Модальное окно открыто, настраиваем обработчики
                                            setTimeout(() => {
                                                const avatarInput = document.getElementById('modal-avatar-input');
                                                if (avatarInput) {
                                                    // Удаляем старый обработчик, если есть
                                                    const newAvatarInput = avatarInput.cloneNode(true);
                                                    avatarInput.parentNode.replaceChild(newAvatarInput, avatarInput);
                                                    
                                                    newAvatarInput.addEventListener('change', (e) => {
                                                        const file = e.target.files[0];
                                                        if (file) {
                                                            // Проверка размера файла
                                                            if (file.size > 5 * 1024 * 1024) {
                                                                alert('Размер файла не должен превышать 5MB');
                                                                newAvatarInput.value = '';
                                                                return;
                                                            }
                                                            
                                                            // Проверка типа файла
                                                            if (!file.type.match('image.*')) {
                                                                alert('Пожалуйста, выберите изображение');
                                                                newAvatarInput.value = '';
                                                                return;
                                                            }
                                                            
                                                            // Показываем имя файла и подсказку
                                                            const fileNameDisplay = document.getElementById('avatar-file-name');
                                                            const saveHint = document.getElementById('avatar-save-hint');
                                                            if (fileNameDisplay) {
                                                                fileNameDisplay.textContent = `✓ Выбрано: ${file.name}`;
                                                                fileNameDisplay.classList.remove('hidden');
                                                            }
                                                            if (saveHint) {
                                                                saveHint.classList.remove('hidden');
                                                            }
                                                            
                                                            // Показываем превью
                                                            const reader = new FileReader();
                                                            reader.onload = (e) => {
                                                                const preview = document.getElementById('modal-avatar-preview');
                                                                if (preview.tagName === 'IMG') {
                                                                    preview.src = e.target.result;
                                                                } else {
                                                                    preview.outerHTML = `<img id="modal-avatar-preview" src="${e.target.result}" alt="Avatar" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-100">`;
                                                                }
                                                            };
                                                            reader.readAsDataURL(file);
                                                        } else {
                                                            const fileNameDisplay = document.getElementById('avatar-file-name');
                                                            if (fileNameDisplay) {
                                                                fileNameDisplay.classList.add('hidden');
                                                            }
                                                        }
                                                    });
                                                }
                                            }, 100);
                                        }
                                    });
                    
                    // Функция для получения CSRF токена
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== '') {
                            const cookies = document.cookie.split(';');
                            for (let i = 0; i < cookies.length; i++) {
                                const cookie = cookies[i].trim();
                                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                    
                    // Функция для получения CSRF токена из формы
                    function getCSRFToken() {
                        // Пробуем получить из cookie
                        let token = getCookie('csrftoken');
                        if (token) {
                            return token;
                        }
                        // Если нет в cookie, получаем из скрытого поля формы
                        const form = document.getElementById('profile-form');
                        if (form) {
                            const csrfInput = form.querySelector('[name=csrfmiddlewaretoken]');
                            if (csrfInput) {
                                return csrfInput.value;
                            }
                        }
                        return null;
                    }
                    
                    // Обработка отправки формы профиля
                    const profileForm = document.getElementById('profile-form');
                    if (profileForm) {
                        profileForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            
                            const formData = new FormData(profileForm);
                            const saveBtn = document.getElementById('save-profile-btn');
                            const messagesDiv = document.getElementById('profile-messages');
                            
                            // Убедимся, что CSRF токен есть в FormData
                            // FormData автоматически включает все поля формы, включая csrfmiddlewaretoken
                            // Но на всякий случай проверим
                            if (!formData.has('csrfmiddlewaretoken')) {
                                const csrfInput = profileForm.querySelector('[name=csrfmiddlewaretoken]');
                                if (csrfInput) {
                                    formData.append('csrfmiddlewaretoken', csrfInput.value);
                                } else {
                                    // Если токена нет в форме, пытаемся получить из cookie
                                    const csrftoken = getCSRFToken();
                                    if (csrftoken) {
                                        formData.append('csrfmiddlewaretoken', csrftoken);
                                    } else {
                                        messagesDiv.innerHTML = '<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"><span class="block sm:inline">Ошибка: не удалось получить CSRF токен. Пожалуйста, обновите страницу.</span></div>';
                                        saveBtn.disabled = false;
                                        saveBtn.textContent = 'Сохранить изменения';
                                        
                                        // Скрываем индикатор загрузки на аватаре
                                        const avatarLoading = document.getElementById('avatar-loading-indicator');
                                        if (avatarLoading) {
                                            avatarLoading.classList.add('hidden');
                                        }
                                        return;
                                    }
                                }
                            }
                            
                            // Показываем индикатор загрузки
                            saveBtn.disabled = true;
                            saveBtn.textContent = 'Сохранение...';
                            messagesDiv.innerHTML = '';
                            
                            // Показываем индикатор загрузки на аватаре
                            const avatarLoading = document.getElementById('avatar-loading-indicator');
                            if (avatarLoading) {
                                avatarLoading.classList.remove('hidden');
                            }
                            
                            // Проверяем, что CSRF токен есть в FormData перед отправкой
                            if (!formData.has('csrfmiddlewaretoken')) {
                                console.error('CSRF токен отсутствует в FormData!');
                                messagesDiv.innerHTML = '<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"><span class="block sm:inline">Ошибка: CSRF токен не найден. Пожалуйста, обновите страницу.</span></div>';
                                saveBtn.disabled = false;
                                saveBtn.textContent = 'Сохранить изменения';
                                const avatarLoading = document.getElementById('avatar-loading-indicator');
                                if (avatarLoading) {
                                    avatarLoading.classList.add('hidden');
                                }
                                return;
                            }
                            
                            fetch('/profile/', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                },
                                credentials: 'same-origin',
                                // Не устанавливаем Content-Type, браузер сам установит с boundary для FormData
                                // CSRF токен должен быть в FormData, а не в заголовках
                            })
                            .then(response => {
                                // Проверяем статус ответа
                                if (response.redirected) {
                                    window.location.reload();
                                    return null;
                                }
                                
                                // Проверяем статус ответа - 404 означает, что URL не найден
                                if (response.status === 404) {
                                    return response.text().then(text => {
                                        console.error('404 Error:', text.substring(0, 200));
                                        throw new Error('Страница не найдена (404). Возможно, сервер не был перезапущен после изменений. Попробуйте перезапустить сервер командой: python manage.py runserver');
                                    });
                                }
                                
                                // Проверяем тип контента
                                const contentType = response.headers.get('content-type') || '';
                                
                                // Если это не JSON, проверяем причину
                                if (!contentType.includes('application/json')) {
                                    return response.text().then(text => {
                                        // Если это HTML ошибка (скорее всего CSRF или 403/500)
                                        if (text.includes('<!DOCTYPE') || text.includes('<html')) {
                                            if (text.includes('CSRF') || text.includes('csrf')) {
                                                throw new Error('Ошибка безопасности. Пожалуйста, обновите страницу и попробуйте снова.');
                                            } else if (response.status === 403) {
                                                throw new Error('Доступ запрещен. Пожалуйста, войдите в систему заново.');
                                            } else if (response.status === 500) {
                                                throw new Error('Ошибка на сервере. Пожалуйста, попробуйте позже.');
                                            } else {
                                                throw new Error(`Ошибка сервера (статус: ${response.status}). Попробуйте обновить страницу.`);
                                            }
                                        }
                                        throw new Error('Неожиданный формат ответа от сервера. Попробуйте обновить страницу.');
                                    });
                                }
                                
                                // Если ответ не OK, пытаемся получить JSON с ошибкой
                                if (!response.ok) {
                                    return response.json().catch(() => {
                                        // Если не удалось распарсить JSON, возвращаем общую ошибку
                                        throw new Error(`Ошибка сервера (статус: ${response.status})`);
                                    }).then(data => {
                                        if (data && (data.errors || data.success === false)) {
                                            return data;
                                        }
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    });
                                }
                                
                                return response.json().catch(() => {
                                    throw new Error('Ошибка при обработке ответа от сервера.');
                                });
                            })
                            .then(data => {
                                if (data) {
                                    if (data.success) {
                                        // Обновляем аватар в навигации
                                        if (data.avatar_url) {
                                            const navAvatar = document.getElementById('nav-avatar');
                                            const navAvatarPlaceholder = document.getElementById('nav-avatar-placeholder');
                                            if (navAvatar) {
                                                navAvatar.src = data.avatar_url + '?t=' + new Date().getTime(); // Добавляем timestamp для обхода кэша
                                            } else if (navAvatarPlaceholder) {
                                                navAvatarPlaceholder.outerHTML = `<img id="nav-avatar" src="${data.avatar_url}?t=${new Date().getTime()}" alt="Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-indigo-200 hover:border-indigo-400 transition-colors">`;
                                            }
                                            
                                            // Также обновляем превью в модальном окне
                                            const modalPreview = document.getElementById('modal-avatar-preview');
                                            if (modalPreview && modalPreview.tagName === 'IMG') {
                                                modalPreview.src = data.avatar_url + '?t=' + new Date().getTime();
                                            }
                                        }
                                        
                                        // Обновляем никнейм в навигации
                                        if (data.username) {
                                            const navUsername = document.getElementById('nav-username');
                                            const navUsernameInitial = document.getElementById('nav-username-initial');
                                            if (navUsername) {
                                                navUsername.textContent = data.username;
                                            }
                                            if (navUsernameInitial) {
                                                navUsernameInitial.textContent = data.username.charAt(0).toUpperCase();
                                            }
                                        }
                                        
                                        // Показываем сообщение об успехе
                                        let successMessage = '<div class="bg-green-50 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">';
                                        if (data.avatar_url) {
                                            successMessage += '<span class="block sm:inline">✓ Фото профиля успешно сохранено!</span>';
                                        } else {
                                            successMessage += '<span class="block sm:inline">✓ Профиль успешно обновлен!</span>';
                                        }
                                        successMessage += '</div>';
                                        messagesDiv.innerHTML = successMessage;
                                        
                                        // Скрываем подсказку о сохранении
                                        const saveHint = document.getElementById('avatar-save-hint');
                                        if (saveHint) {
                                            saveHint.classList.add('hidden');
                                        }
                                        
                                        // Обновляем имя файла или скрываем его
                                        const fileNameDisplay = document.getElementById('avatar-file-name');
                                        if (fileNameDisplay && data.avatar_url) {
                                            fileNameDisplay.textContent = '✓ Фото сохранено';
                                            setTimeout(() => {
                                                fileNameDisplay.classList.add('hidden');
                                            }, 2000);
                                        }
                                        
                                        // Очищаем поле выбора файла, чтобы можно было загрузить то же фото снова
                                        setTimeout(() => {
                                            const avatarInput = document.getElementById('modal-avatar-input');
                                            if (avatarInput) {
                                                avatarInput.value = '';
                                            }
                                        }, 1000);
                                        
                                        // Закрываем модальное окно через 2 секунды
                                        setTimeout(() => {
                                            // Диспетчеризуем событие для закрытия модального окна
                                            window.dispatchEvent(new CustomEvent('close-profile-modal'));
                                            messagesDiv.innerHTML = '';
                                        }, 2000);
                                    } else {
                                        // Показываем ошибки
                                        let errorHtml = '<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">';
                                        if (data.errors && Array.isArray(data.errors)) {
                                            if (data.errors.length === 1) {
                                                errorHtml += `<span class="block sm:inline">✗ ${data.errors[0]}</span>`;
                                            } else {
                                                errorHtml += '<ul class="list-disc list-inside">';
                                                data.errors.forEach(error => {
                                                    errorHtml += `<li>${error}</li>`;
                                                });
                                                errorHtml += '</ul>';
                                            }
                                        } else if (data.errors && typeof data.errors === 'object') {
                                            errorHtml += '<ul class="list-disc list-inside">';
                                            Object.values(data.errors).forEach(error => {
                                                if (Array.isArray(error)) {
                                                    error.forEach(err => errorHtml += `<li>${err}</li>`);
                                                } else {
                                                    errorHtml += `<li>${error}</li>`;
                                                }
                                            });
                                            errorHtml += '</ul>';
                                        } else {
                                            errorHtml += '<span class="block sm:inline">✗ Ошибка при сохранении профиля</span>';
                                        }
                                        errorHtml += '</div>';
                                        messagesDiv.innerHTML = errorHtml;
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                let errorMessage = 'Произошла ошибка при сохранении профиля';
                                if (error.message) {
                                    errorMessage += ': ' + error.message;
                                }
                                messagesDiv.innerHTML = `<div class="bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert"><span class="block sm:inline">${errorMessage}</span></div>`;
                                
                                // Скрываем индикатор загрузки на аватаре
                                const avatarLoading = document.getElementById('avatar-loading-indicator');
                                if (avatarLoading) {
                                    avatarLoading.classList.add('hidden');
                                }
                            })
                            .finally(() => {
                                saveBtn.disabled = false;
                                saveBtn.textContent = 'Сохранить изменения';
                                
                                // Скрываем индикатор загрузки на аватаре
                                const avatarLoading = document.getElementById('avatar-loading-indicator');
                                if (avatarLoading) {
                                    avatarLoading.classList.add('hidden');
                                }
                            });
                        });
                    }
                }
            }));
        });
    </script>
    {% endif %}
</body>
</html>

