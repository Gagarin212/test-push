{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ - –û–Ω–ª–∞–π–Ω-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        width: 100%;
        height: 100%;
    }
    /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    #preview-container {
        display: flex;
        align-items: flex-start;
        justify-content: center;
        width: 100%;
        height: 100%;
    }
    #portfolio-preview {
        max-width: 100%;
        width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        overflow-x: hidden;
    }
    
    /* –ü–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ preview */
    #portfolio-preview * {
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –≤ preview */
    #portfolio-preview,
    #portfolio-preview > div,
    #preview-container {
        overflow-x: hidden !important;
        max-width: 100% !important;
    }
    
    /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ –∏ URL */
    #portfolio-preview p,
    #portfolio-preview div,
    #portfolio-preview span,
    #portfolio-preview a,
    #portfolio-preview h1,
    #portfolio-preview h2,
    #portfolio-preview h3,
    #portfolio-preview h4,
    #portfolio-preview h5,
    #portfolio-preview h6,
    #portfolio-preview li,
    #portfolio-preview td,
    #portfolio-preview th {
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        max-width: 100%;
    }
    
    /* –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã */
    #portfolio-preview > div {
        max-width: 100% !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }
    
    /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª—è –≤—Å–µ—Ö –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    #portfolio-preview * {
        max-width: 100%;
        box-sizing: border-box;
    }
    
    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    #portfolio-preview img {
        object-fit: cover;
        object-position: center;
        display: block;
        vertical-align: middle;
        max-width: 100%;
        height: auto;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    #portfolio-preview div[style*="flex"] img,
    #portfolio-preview div[style*="display: flex"] img {
        align-self: center;
    }
    
    /* Custom blocks responsive - stack on mobile */
    @media (max-width: 768px) {
        #portfolio-preview .custom-block-grid {
            grid-template-columns: 1fr !important;
        }
        #portfolio-preview .custom-block-image-area {
            order: -1;
        }
        #portfolio-preview .custom-block-image-area img {
            max-height: 180px !important;
        }
        #portfolio-preview .custom-block-text-area {
            padding-right: 0 !important;
            padding-top: 12px;
        }
        #portfolio-preview .custom-block-title {
            font-size: calc(1em * 0.85) !important;
        }
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 1024px) {
        body.portfolio-editor-page .fade-in-section {
            grid-template-columns: 1fr !important;
            grid-template-rows: auto 1fr !important;
        }
        body.portfolio-editor-page .portfolio-editor-panel {
            max-height: 50vh !important;
            overflow-y: auto !important;
        }
        body.portfolio-editor-page .portfolio-preview-container {
            height: 50vh !important;
        }
        #portfolio-preview > div {
            padding: 20px !important;
        }
        #portfolio-preview > div > div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
    }
    @media (max-width: 768px) {
        body.portfolio-editor-page .portfolio-editor-panel {
            max-height: 40vh !important;
        }
        body.portfolio-editor-page .portfolio-preview-container {
            height: 60vh !important;
        }
        #portfolio-preview > div {
            padding: 16px !important;
        }
        #portfolio-preview h1 {
            font-size: 32px !important;
        }
        #portfolio-preview h2 {
            font-size: 20px !important;
        }
    }
    @media (max-width: 640px) {
        #portfolio-preview > div {
            padding: 12px !important;
        }
        #portfolio-preview > div > div[style*="padding: 24px"] {
            padding: 16px !important;
        }
    }
    /* –†–µ–¥–∞–∫—Ç–æ—Ä —Å–ª–µ–≤–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
    .editor-scroll {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
        overflow-y: auto;
        overflow-x: hidden;
        flex: 1;
        min-height: 0;
    }
    .editor-scroll::-webkit-scrollbar {
        width: 8px;
    }
    .editor-scroll::-webkit-scrollbar-track {
        background: #f7fafc;
    }
    .editor-scroll::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    .editor-scroll::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    
    /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä - —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å */
    .preview-content {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }
    .preview-content::-webkit-scrollbar {
        width: 8px;
    }
    .preview-content::-webkit-scrollbar-track {
        background: #f7fafc;
    }
    .preview-content::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    .preview-content::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    /* –û—Ç–∫–ª—é—á–∏—Ç—å —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    body.portfolio-editor-page {
        overflow: hidden !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    /* –£–±—Ä–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã —É main –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    body.portfolio-editor-page main {
        margin: 0 !important;
        padding: 0 !important;
        height: 100vh !important;
        overflow: hidden !important;
        position: relative !important;
    }
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ - CSS Grid */
    body.portfolio-editor-page .fade-in-section {
        margin-top: 0 !important;
        padding-top: 0 !important;
        height: calc(100vh - 56px) !important;
        position: relative !important;
        top: 56px !important;
        display: grid !important;
        grid-template-columns: 360px 1fr !important;
        grid-template-rows: 1fr !important;
        overflow: hidden !important;
        width: 100% !important;
    }
    /* –†–µ–¥–∞–∫—Ç–æ—Ä (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å) */
    body.portfolio-editor-page .portfolio-editor-panel {
        position: relative !important;
        top: 0 !important;
        height: 100% !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        border-right: 1px solid #e5e7eb !important;
        background: white !important;
        z-index: 10 !important;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫—Ä–æ–ª–ª–∞ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    body.portfolio-editor-page .portfolio-editor-panel .editor-scroll {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }
    /* –°–∫—Ä—ã—Ç—å –ø–æ–¥–≤–∞–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    body.portfolio-editor-page #main-footer {
        display: none !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
    }
    
    /* –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ footer –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ layout */
    body.portfolio-editor-page footer {
        display: none !important;
        visibility: hidden !important;
        height: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    /* –£–±—Ä–∞—Ç—å –æ—Ç—Å—Ç—É–ø—ã —É body */
    body.portfolio-editor-page {
        margin: 0 !important;
        padding: 0 !important;
    }
    /* –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —à–∞–ø–∫–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏ –∫–∞—Å–∞–µ—Ç—Å—è –≤–µ—Ä—Ö–∞ */
    body.portfolio-editor-page nav {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 50 !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 56px !important;
    }
    /* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä (–ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å) */
    body.portfolio-editor-page .portfolio-preview-container {
        position: relative !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        height: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        background: #f9fafb !important;
    }
    /* –£–±—Ä–∞—Ç—å –≤—Å–µ –≤–Ω–µ—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
    body.portfolio-editor-page * {
        box-sizing: border-box;
    }
    .template-card {
        transition: all 0.3s;
        cursor: pointer;
    }
    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .template-card.selected {
        border-color: #4f46e5;
        border-width: 3px;
    }
    .portfolio-item {
        cursor: move;
        transition: transform 0.2s;
    }
    .portfolio-item:hover {
        transform: translateY(-2px);
    }
    .portfolio-item.sortable-ghost {
        opacity: 0.5;
    }
    .portfolio-item.sortable-chosen {
        background-color: #eff6ff;
    }
    .content-form {
        display: block;
    }
    .content-form.hidden {
        display: none;
    }
    #editor-modal {
        z-index: 9999;
    }
    #editor-modal .overflow-y-auto {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }
    #editor-modal .overflow-y-auto::-webkit-scrollbar {
        width: 8px;
    }
    #editor-modal .overflow-y-auto::-webkit-scrollbar-track {
        background: #f7fafc;
    }
    #editor-modal .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 1024px) {
        .fixed.left-0 {
            position: relative;
            width: 100%;
        }
        .ml-96 {
            margin-left: 0;
        }
        .preview-container {
            min-height: 300px;
            padding: 1rem;
        }
        #portfolio-preview {
            width: 100%;
        }
        .portfolio-editor-page {
            height: 100vh;
            overflow: hidden;
        }
    }
    @media (max-width: 640px) {
        .preview-container {
            min-height: 250px;
            padding: 0.5rem;
        }
    }
    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π */
    .social-link-item {
        min-width: 0;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }
    .social-link-item .social-platform {
        min-width: 0;
        max-width: 120px;
        flex-shrink: 0;
        box-sizing: border-box;
    }
    .social-link-item .social-url {
        min-width: 0;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .social-link-item button {
        flex-shrink: 0;
        box-sizing: border-box;
    }
    #social-links-container {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        overflow: hidden;
    }
    </style>
{% endblock %}

{% block content %}
<div class="fade-in-section portfolio-editor-grid">
    <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –†–µ–¥–∞–∫—Ç–æ—Ä -->
    <div class="portfolio-editor-panel">
            <div class="flex-1 overflow-y-auto editor-scroll" style="min-height: 0; -webkit-overflow-scrolling: touch;">
                <div class="p-4" style="padding-top: 1rem; padding-bottom: 1rem;">
                    <div class="space-y-4">
                    <!-- –°–µ–∫—Ü–∏—è 1: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">‚úèÔ∏è</span>
                            <h2 class="text-base font-semibold text-gray-900">–¢–µ–∫—Å—Ç –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">–ò–º—è</label>
                                <input type="text" id="portfolio-name" value="{% if portfolio.name %}{{ portfolio.name }}{% else %}–ú–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ{% endif %}" 
                                       placeholder="–í–∞—à–µ –∏–º—è"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                                <input type="text" id="portfolio-profession" value="{% if portfolio.description %}{{ portfolio.description|truncatewords:5 }}{% endif %}" 
                                       placeholder="–í–∞—à–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                                <textarea id="portfolio-description" rows="3" 
                                          placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."
                                          class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition resize-none">{% if portfolio.description %}{{ portfolio.description }}{% endif %}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üìù</span>
                            <h2 class="text-base font-semibold text-gray-900">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞</h2>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–®—Ä–∏—Ñ—Ç</label>
                                <div class="flex gap-1">
                                    <select id="text-font-family" class="flex-1 px-2.5 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <optgroup label="–ë–µ–∑ –∑–∞—Å–µ—á–µ–∫ (Sans-serif)">
                                            <option value="Inter">Inter</option>
                                            <option value="Roboto">Roboto</option>
                                            <option value="Open Sans">Open Sans</option>
                                            <option value="Lato">Lato</option>
                                            <option value="Montserrat">Montserrat</option>
                                            <option value="Poppins">Poppins</option>
                                            <option value="Raleway">Raleway</option>
                                            <option value="Nunito">Nunito</option>
                                            <option value="Ubuntu">Ubuntu</option>
                                            <option value="Source Sans Pro">Source Sans Pro</option>
                                            <option value="Work Sans">Work Sans</option>
                                            <option value="DM Sans">DM Sans</option>
                                            <option value="Manrope">Manrope</option>
                                            <option value="Plus Jakarta Sans">Plus Jakarta Sans</option>
                                            <option value="Outfit">Outfit</option>
                                        </optgroup>
                                        <optgroup label="–° –∑–∞—Å–µ—á–∫–∞–º–∏ (Serif)">
                                            <option value="Playfair Display">Playfair Display</option>
                                            <option value="Merriweather">Merriweather</option>
                                            <option value="Lora">Lora</option>
                                            <option value="Crimson Text">Crimson Text</option>
                                            <option value="PT Serif">PT Serif</option>
                                            <option value="Libre Baskerville">Libre Baskerville</option>
                                            <option value="Cormorant Garamond">Cormorant Garamond</option>
                                        </optgroup>
                                        <optgroup label="–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–µ (Monospace)">
                                            <option value="Roboto Mono">Roboto Mono</option>
                                            <option value="Source Code Pro">Source Code Pro</option>
                                            <option value="Fira Code">Fira Code</option>
                                            <option value="JetBrains Mono">JetBrains Mono</option>
                                        </optgroup>
                                        <optgroup label="–î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ">
                                            <option value="Dancing Script">Dancing Script</option>
                                            <option value="Pacifico">Pacifico</option>
                                            <option value="Caveat">Caveat</option>
                                            <option value="Comfortaa">Comfortaa</option>
                                        </optgroup>
                                    </select>
                                    <button onclick="downloadFont()" class="px-2 py-1.5 text-xs bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500" title="–°–∫–∞—á–∞—Ç—å —à—Ä–∏—Ñ—Ç">
                                        ‚¨áÔ∏è
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">–®—Ä–∏—Ñ—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Google Fonts</p>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–†–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="text-h1-size" min="24" max="72" value="48" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="text-h1-size-value" class="text-xs text-gray-600 w-12 text-right">48px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–†–∞–∑–º–µ—Ä –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="text-h2-size" min="16" max="48" value="24" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="text-h2-size-value" class="text-xs text-gray-600 w-12 text-right">24px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–†–∞–∑–º–µ—Ä –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="text-body-size" min="12" max="24" value="16" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="text-body-size-value" class="text-xs text-gray-600 w-12 text-right">16px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</label>
                                <div class="flex gap-1">
                                    <button onclick="setTextAlign('left')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 text-align-btn" data-align="left" type="button">‚¨ÖÔ∏è –°–ª–µ–≤–∞</button>
                                    <button onclick="setTextAlign('center')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 text-align-btn" data-align="center" type="button">‚ÜîÔ∏è –¶–µ–Ω—Ç—Ä</button>
                                    <button onclick="setTextAlign('right')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 text-align-btn" data-align="right" type="button">‚û°Ô∏è –°–ø—Ä–∞–≤–∞</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —à—Ä–∏—Ñ—Ç–∞</label>
                                <select id="text-font-weight" class="w-full px-2.5 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="300">–¢–æ–Ω–∫–∏–π (300)</option>
                                    <option value="400" selected>–û–±—ã—á–Ω—ã–π (400)</option>
                                    <option value="500">–°—Ä–µ–¥–Ω–∏–π (500)</option>
                                    <option value="600">–ü–æ–ª—É–∂–∏—Ä–Ω—ã–π (600)</option>
                                    <option value="700">–ñ–∏—Ä–Ω—ã–π (700)</option>
                                    <option value="800">–û—á–µ–Ω—å –∂–∏—Ä–Ω—ã–π (800)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="text-line-height" min="1" max="2" step="0.1" value="1.6" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="text-line-height-value" class="text-xs text-gray-600 w-12 text-right">1.6</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–ú–µ–∂–±—É–∫–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="text-letter-spacing" min="-2" max="5" step="0.5" value="0" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="text-letter-spacing-value" class="text-xs text-gray-600 w-12 text-right">0px</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è 2: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üì∑</span>
                            <h2 class="text-base font-semibold text-gray-900">–§–æ—Ç–æ</h2>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–§–æ—Ä–º–∞ –∞–≤–∞—Ç–∞—Ä–∞</label>
                                <select id="avatar-shape" class="w-full px-2.5 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="circle" selected>–ö—Ä—É–≥</option>
                                    <option value="rounded">–°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π</option>
                                    <option value="square">–ö–≤–∞–¥—Ä–∞—Ç</option>
                                </select>
                            </div>
                            <label class="block text-xs font-medium text-gray-700 mb-1.5">–ê–≤–∞—Ç–∞—Ä</label>
                            <div class="flex items-center gap-3">
                                <div class="flex-shrink-0">
                                    {% if portfolio.avatar %}
                                    <img src="{{ portfolio.avatar.url }}" alt="Avatar" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200" id="avatar-preview">
                                    {% else %}
                                    <div class="w-16 h-16 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center" id="avatar-preview">
                                        <span class="text-gray-400 text-xs text-center px-1">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="avatar-input" accept="image/*" 
                                           class="w-full px-2.5 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition cursor-pointer">
                                    <p class="text-xs text-gray-500 mt-0.5">JPG, PNG –¥–æ 5MB</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–æ–Ω—Ç–∞–∫—Ç—ã (–≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üìû</span>
                            <h2 class="text-base font-semibold text-gray-900">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" id="portfolio-phone" value="{{ portfolio.phone|default:'' }}" 
                                       placeholder="+7 (999) 123-45-67"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">Email</label>
                                <input type="email" id="portfolio-email" value="{{ portfolio.email|default:'' }}" 
                                       placeholder="example@email.com"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">–í–µ–±-—Å–∞–π—Ç</label>
                                <input type="url" id="portfolio-website" value="{{ portfolio.website|default:'' }}" 
                                       placeholder="https://example.com"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1.5">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
                                <input type="text" id="portfolio-location" value="{{ portfolio.location|default:'' }}" 
                                       placeholder="–ì–æ—Ä–æ–¥, –°—Ç—Ä–∞–Ω–∞"
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</label>
                                <div id="social-links-container" class="space-y-1.5 mb-1.5" style="width: 100%; max-width: 100%; box-sizing: border-box; overflow: hidden;">
                                    {% if portfolio.social_links %}
                                        {% for key, value in portfolio.social_links.items %}
                                        {% if value %}
                                        <div class="flex gap-1.5 social-link-item" style="min-width: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                                            <select class="px-2 py-1.5 text-xs border border-gray-300 rounded-md flex-shrink-0 social-platform" style="max-width: 120px; min-width: 80px; box-sizing: border-box;">
                                                <option value="vk" {% if key == 'vk' %}selected{% endif %}>VK</option>
                                                <option value="instagram" {% if key == 'instagram' %}selected{% endif %}>Instagram</option>
                                                <option value="facebook" {% if key == 'facebook' %}selected{% endif %}>Facebook</option>
                                                <option value="linkedin" {% if key == 'linkedin' %}selected{% endif %}>LinkedIn</option>
                                                <option value="github" {% if key == 'github' %}selected{% endif %}>GitHub</option>
                                                <option value="twitter" {% if key == 'twitter' %}selected{% endif %}>Twitter/X</option>
                                                <option value="telegram" {% if key == 'telegram' %}selected{% endif %}>Telegram</option>
                                                <option value="youtube" {% if key == 'youtube' %}selected{% endif %}>YouTube</option>
                                            </select>
                                            <input type="url" value="{{ value }}" placeholder="https://..." 
                                                   class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md social-url" style="min-width: 0; max-width: 100%; box-sizing: border-box; overflow: hidden;">
                                            <button onclick="removeSocialLink(this)" class="px-1.5 py-1.5 text-red-600 hover:text-red-800 text-sm flex-shrink-0" type="button">√ó</button>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                                <button onclick="addSocialLink()" class="w-full px-2.5 py-1.5 text-xs bg-gray-50 text-gray-700 rounded-md hover:bg-gray-100 transition" type="button">
                                    + –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω—É—é —Å–µ—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- –ù–∞–≤—ã–∫–∏ (–≤–Ω—É—Ç—Ä–∏ —Å–µ–∫—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞) -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üíº</span>
                            <h2 class="text-base font-semibold text-gray-900">–ù–∞–≤—ã–∫–∏</h2>
                        </div>
                        <div id="skills-container" class="space-y-2 mb-2">
                            {% if portfolio.skills %}{% for skill in portfolio.skills %}
                            <div class="flex gap-2 skill-item">
                                <input type="text" value="{{ skill }}" placeholder="–ù–∞–≤—ã–∫" 
                                       class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg skill-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                                <button onclick="removeSkill(this)" class="px-2 py-2 text-red-600 hover:text-red-800 text-sm" type="button">√ó</button>
                            </div>
                            {% endfor %}{% endif %}
                        </div>
                        <button onclick="addSkill()" class="w-full px-3 py-2 text-sm bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition" type="button">
                            + –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–≤—ã–∫
                        </button>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–æ–Ω–∞ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üé®</span>
                            <h2 class="text-base font-semibold text-gray-900">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</h2>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                                <div class="flex gap-1.5">
                                    <input type="color" id="color-background" value="{% if portfolio.color_scheme and portfolio.color_scheme.background_color %}{{ portfolio.color_scheme.background_color }}{% else %}#ffffff{% endif %}" 
                                           class="w-12 h-10 border border-gray-300 rounded cursor-pointer">
                                    <input type="text" id="color-background-text" value="{% if portfolio.color_scheme and portfolio.color_scheme.background_color %}{{ portfolio.color_scheme.background_color }}{% else %}#ffffff{% endif %}" 
                                           class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                           pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                </div>
                                <div id="background-preview" class="mt-2 h-8 rounded border border-gray-200" style="background: {% if portfolio.color_scheme and portfolio.color_scheme.background_color %}{{ portfolio.color_scheme.background_color }}{% else %}#ffffff{% endif %};"></div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5">–¢–∏–ø —Ñ–æ–Ω–∞</label>
                                <select id="background-type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="solid" {% if not portfolio.color_scheme or not portfolio.color_scheme.background_type or portfolio.color_scheme.background_type == 'solid' %}selected{% endif %}>–°–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç</option>
                                    <option value="gradient" {% if portfolio.color_scheme and portfolio.color_scheme.background_type == 'gradient' %}selected{% endif %}>–ì—Ä–∞–¥–∏–µ–Ω—Ç</option>
                                </select>
                            </div>
                            <div id="gradient-opacity-control" class="{% if portfolio.color_scheme and portfolio.color_scheme.background_type == 'gradient' %}{% else %}hidden{% endif %}">
                                <label class="block text-xs font-medium text-gray-700 mb-1.5">–í—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</label>
                                <div class="flex gap-1.5">
                                    <input type="color" id="color-background-2" value="{% if portfolio.color_scheme and portfolio.color_scheme.background_color_2 %}{{ portfolio.color_scheme.background_color_2 }}{% else %}#f3f4f6{% endif %}" 
                                           class="w-12 h-10 border border-gray-300 rounded cursor-pointer">
                                    <input type="text" id="color-background-2-text" value="{% if portfolio.color_scheme and portfolio.color_scheme.background_color_2 %}{{ portfolio.color_scheme.background_color_2 }}{% else %}#f3f4f6{% endif %}" 
                                           class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                           pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                </div>
                                <div id="gradient-preview" class="mt-2 h-8 rounded border border-gray-200" style="background: linear-gradient(135deg, {% if portfolio.color_scheme and portfolio.color_scheme.background_color %}{{ portfolio.color_scheme.background_color }}{% else %}#ffffff{% endif %} 0%, {% if portfolio.color_scheme and portfolio.color_scheme.background_color_2 %}{{ portfolio.color_scheme.background_color_2 }}{% else %}#f3f4f6{% endif %} 100%);"></div>
                            </div>
                            <div class="border-t border-gray-200 pt-3 mt-3">
                                <label class="block text-xs font-medium text-gray-700 mb-1.5">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫/—Å–µ–∫—Ü–∏–π</label>
                                <p class="text-xs text-gray-500 mb-1.5">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º (–∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–æ–Ω—Ç–∞–∫—Ç—ã –∏ —Ç.–¥.)</p>
                                <div class="flex gap-1.5">
                                    <input type="color" id="color-card-background" value="{% if portfolio.color_scheme and portfolio.color_scheme.card_background %}{{ portfolio.color_scheme.card_background }}{% else %}#374151{% endif %}" 
                                           class="w-12 h-10 border border-gray-300 rounded cursor-pointer">
                                    <input type="text" id="color-card-background-text" value="{% if portfolio.color_scheme and portfolio.color_scheme.card_background %}{{ portfolio.color_scheme.card_background }}{% else %}#374151{% endif %}" 
                                           class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                           pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                </div>
                                <div id="card-background-preview" class="mt-2 h-8 rounded border border-gray-200" style="background: {% if portfolio.color_scheme and portfolio.color_scheme.card_background %}{{ portfolio.color_scheme.card_background }}{% else %}#374151{% endif %};"></div>
                            </div>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">üé®</span>
                                <h2 class="text-base font-semibold text-gray-900">–¶–≤–µ—Ç–∞</h2>
                            </div>
                            <button onclick="resetColors()" class="px-2 py-1 text-xs text-gray-600 hover:text-indigo-600 hover:bg-gray-50 rounded transition" type="button" title="–°–±—Ä–æ—Å–∏—Ç—å –∫ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–π —Ç–µ–º–µ">
                                üîÑ –°–±—Ä–æ—Å
                            </button>
                        </div>
                        <div class="space-y-3">
                            <!-- –¶–≤–µ—Ç–æ–≤—ã–µ –ø—Ä–µ—Å–µ—Ç—ã -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1.5">–¶–≤–µ—Ç–æ–≤—ã–µ —Ç–µ–º—ã</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="applyColorPreset('blue-professional')" class="color-preset-btn px-3 py-2 text-xs border-2 border-gray-300 rounded-lg hover:border-indigo-500 transition text-left" data-preset="blue-professional" type="button">
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 rounded" style="background: #2563EB;"></div>
                                            <span>Blue Professional</span>
                                        </div>
                                    </button>
                                    <button onclick="applyColorPreset('purple-creative')" class="color-preset-btn px-3 py-2 text-xs border-2 border-gray-300 rounded-lg hover:border-indigo-500 transition text-left" data-preset="purple-creative" type="button">
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 rounded" style="background: #7C3AED;"></div>
                                            <span>Purple Creative</span>
                                        </div>
                                    </button>
                                    <button onclick="applyColorPreset('dark-minimal')" class="color-preset-btn px-3 py-2 text-xs border-2 border-gray-300 rounded-lg hover:border-indigo-500 transition text-left" data-preset="dark-minimal" type="button">
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 rounded" style="background: #1F2937;"></div>
                                            <span>Dark Minimal</span>
                                        </div>
                                    </button>
                                    <button onclick="applyColorPreset('green-tech')" class="color-preset-btn px-3 py-2 text-xs border-2 border-gray-300 rounded-lg hover:border-indigo-500 transition text-left" data-preset="green-tech" type="button">
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 rounded" style="background: #16A34A;"></div>
                                            <span>Green Tech</span>
                                        </div>
                                    </button>
                                </div>
                                <button onclick="enableCustomColors()" class="mt-2 w-full px-3 py-1.5 text-xs border border-gray-300 rounded-lg hover:bg-gray-50 transition" type="button">
                                    üé® –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞
                                </button>
                            </div>
                            
                            <!-- –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            <div id="custom-colors-section" class="hidden space-y-2">
                                <div class="border-t border-gray-200 pt-2">
                                    <label class="block text-xs font-medium text-gray-700 mb-1">–û—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç (Primary)</label>
                                    <p class="text-xs text-gray-500 mb-1.5">–ó–∞–≥–æ–ª–æ–≤–∫–∏, –∫–Ω–æ–ø–∫–∏, –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã</p>
                                    <div class="flex gap-1.5">
                                        <input type="color" id="color-primary" value="{% if portfolio.color_scheme and portfolio.color_scheme.primary_color %}{{ portfolio.color_scheme.primary_color }}{% else %}#2563EB{% endif %}" 
                                               class="w-10 h-9 border border-gray-300 rounded cursor-pointer">
                                        <input type="text" id="color-primary-text" value="{% if portfolio.color_scheme and portfolio.color_scheme.primary_color %}{{ portfolio.color_scheme.primary_color }}{% else %}#2563EB{% endif %}" 
                                               class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                               pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                    </div>
                                    <div id="primary-contrast-warning" class="hidden mt-1 text-xs text-red-600"></div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç (Accent)</label>
                                    <p class="text-xs text-gray-500 mb-1.5">–ò–∫–æ–Ω–∫–∏, —Å—Å—ã–ª–∫–∏, —Ç–µ–≥–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–º–µ—Ä–µ–Ω–Ω–æ)</p>
                                    <div class="flex gap-1.5">
                                        <input type="color" id="color-accent" value="{% if portfolio.color_scheme and portfolio.color_scheme.accent_color %}{{ portfolio.color_scheme.accent_color }}{% else %}#1E40AF{% endif %}" 
                                               class="w-10 h-9 border border-gray-300 rounded cursor-pointer">
                                        <input type="text" id="color-accent-text" value="{% if portfolio.color_scheme and portfolio.color_scheme.accent_color %}{{ portfolio.color_scheme.accent_color }}{% else %}#1E40AF{% endif %}" 
                                               class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                               pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                    </div>
                                    <div id="accent-contrast-warning" class="hidden mt-1 text-xs text-red-600"></div>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">–§–æ–Ω (Background)</label>
                                    <p class="text-xs text-gray-500 mb-1.5">–°–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç –∏–ª–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç (–º–∞–∫—Å. 2 —Ü–≤–µ—Ç–∞)</p>
                                    <div class="flex gap-1.5">
                                        <input type="color" id="color-background" value="{% if portfolio.color_scheme and portfolio.color_scheme.background_color %}{{ portfolio.color_scheme.background_color }}{% else %}#ffffff{% endif %}" 
                                               class="w-10 h-9 border border-gray-300 rounded cursor-pointer">
                                        <input type="text" id="color-background-text" value="{% if portfolio.color_scheme and portfolio.color_scheme.background_color %}{{ portfolio.color_scheme.background_color }}{% else %}#ffffff{% endif %}" 
                                               class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                               pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                    </div>
                                    <div class="mt-2">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">–¢–∏–ø —Ñ–æ–Ω–∞</label>
                                        <select id="background-type" class="w-full px-2.5 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="solid">–°–ø–ª–æ—à–Ω–æ–π —Ü–≤–µ—Ç</option>
                                            <option value="gradient">–ì—Ä–∞–¥–∏–µ–Ω—Ç (–ª–∏–Ω–µ–π–Ω—ã–π, 2 —Ü–≤–µ—Ç–∞)</option>
                                        </select>
                                    </div>
                                    <div id="gradient-opacity-control" class="hidden mt-2">
                                        <label class="block text-xs font-medium text-gray-700 mb-1">–í—Ç–æ—Ä–æ–π —Ü–≤–µ—Ç –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</label>
                                        <div class="flex gap-1.5">
                                            <input type="color" id="color-background-2" value="#f3f4f6" 
                                                   class="w-10 h-9 border border-gray-300 rounded cursor-pointer">
                                            <input type="text" id="color-background-2-text" value="#f3f4f6" 
                                                   class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md color-hex-input focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" 
                                                   pattern="^#[0-9A-Fa-f]{6}$" placeholder="#RRGGBB">
                                        </div>
                                    </div>
                                    <div id="background-contrast-warning" class="hidden mt-1 text-xs text-red-600"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–∫–µ—Ç–∞ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üìê</span>
                            <h2 class="text-base font-semibold text-gray-900">–ú–∞–∫–µ—Ç</h2>
                        </div>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–¢–∏–ø –º–∞–∫–µ—Ç–∞</label>
                                <select id="layout-type" class="w-full px-2.5 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    <option value="centered">–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</option>
                                    <option value="left-right">–¢–µ–∫—Å—Ç —Å–ª–µ–≤–∞ / –§–æ—Ç–æ —Å–ø—Ä–∞–≤–∞</option>
                                    <option value="top-bottom">–§–æ—Ç–æ —Å–≤–µ—Ä—Ö—É / –¢–µ–∫—Å—Ç —Å–Ω–∏–∑—É</option>
                                    <option value="cards">–ö–∞—Ä—Ç–æ—á–∫–∏</option>
                                    <option value="list">–°–ø–∏—Å–æ–∫</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–°–µ—Ç–∫–∞ —Ä–∞–±–æ—Ç</label>
                                <div class="flex gap-1">
                                    <button onclick="setGridColumns(1)" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 grid-cols-btn" data-cols="1" type="button">1</button>
                                    <button onclick="setGridColumns(2)" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 grid-cols-btn" data-cols="2" type="button">2</button>
                                    <button onclick="setGridColumns(3)" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 grid-cols-btn" data-cols="3" type="button">3</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–†–∞–∑–º–µ—Ä –ø—Ä–µ–≤—å—é —Ä–∞–±–æ—Ç</label>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="item-preview-size" min="80" max="200" value="128" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="item-preview-size-value" class="text-xs text-gray-600 w-12 text-right">128px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏</label>
                                <div class="flex gap-1 mb-1.5">
                                    <button onclick="setSpacingPreset('compact')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 spacing-preset-btn" data-preset="compact" type="button">–ö–æ–º–ø–∞–∫—Ç–Ω–æ</button>
                                    <button onclick="setSpacingPreset('normal')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 spacing-preset-btn active bg-indigo-100" data-preset="normal" type="button">–û–±—ã—á–Ω–æ</button>
                                    <button onclick="setSpacingPreset('spacious')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 spacing-preset-btn" data-preset="spacious" type="button">–ü—Ä–æ—Å—Ç–æ—Ä–Ω–æ</button>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="range" id="block-spacing" min="8" max="48" value="24" 
                                           class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                    <span id="block-spacing-value" class="text-xs text-gray-600 w-12 text-right">24px</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–°—Ç–∏–ª—å –∫–∞—Ä—Ç–æ—á–µ–∫</label>
                                <div class="flex gap-1">
                                    <button onclick="setCardStyle('flat')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 card-style-btn" data-style="flat" type="button">–ü–ª–æ—Å–∫–∏–µ</button>
                                    <button onclick="setCardStyle('elevated')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 card-style-btn active bg-indigo-100" data-style="elevated" type="button">–° —Ç–µ–Ω—å—é</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤</label>
                                <div class="flex gap-1">
                                    <button onclick="setBorderRadius('none')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 border-radius-btn" data-radius="none" type="button">–ù–µ—Ç</button>
                                    <button onclick="setBorderRadius('small')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 border-radius-btn" data-radius="small" type="button">–ú–∞–ª–µ–Ω—å–∫–æ–µ</button>
                                    <button onclick="setBorderRadius('medium')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 border-radius-btn active bg-indigo-100" data-radius="medium" type="button">–°—Ä–µ–¥–Ω–µ–µ</button>
                                    <button onclick="setBorderRadius('large')" class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md hover:bg-gray-50 border-radius-btn" data-radius="large" type="button">–ë–æ–ª—å—à–æ–µ</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üëÅÔ∏è</span>
                            <h2 class="text-base font-semibold text-gray-900">–í–∏–¥–∏–º–æ—Å—Ç—å –±–ª–æ–∫–æ–≤</h2>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-contacts" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-skills" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–ù–∞–≤—ã–∫–∏</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-experience" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-education" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-certificates" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-languages" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–Ø–∑—ã–∫–∏</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="block-works" checked class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                <span class="text-xs text-gray-700">–ú–æ–∏ —Ä–∞–±–æ—Ç—ã</span>
                            </label>
                        </div>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è 4: –ë–ª–æ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üìã</span>
                            <h2 class="text-base font-semibold text-gray-900">–ú–æ–∏ —Ä–∞–±–æ—Ç—ã</h2>
                        </div>
                        <div id="portfolio-items" class="space-y-2 mb-2" style="min-height: 80px;">
                            {% if portfolio.items.all %}
                                {% for item in portfolio.items.all %}
                                <div class="portfolio-item bg-gray-50 p-3 rounded-lg border border-gray-200 cursor-move hover:border-indigo-300 transition" data-item-id="{{ item.id }}">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <h3 class="font-semibold text-sm text-gray-900">{{ item.title }}</h3>
                                            {% if item.category %}
                                            <span class="text-xs text-gray-500">{{ item.category }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="flex gap-1">
                                            <button onclick="editItem({{ forloop.counter0 }})" class="px-2 py-1 text-blue-600 hover:text-blue-800 text-xs" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" type="button">‚úèÔ∏è</button>
                                            <button onclick="removeItem({{ forloop.counter0 }})" class="px-2 py-1 text-red-600 hover:text-red-800 text-xs" title="–£–¥–∞–ª–∏—Ç—å" type="button">√ó</button>
                                        </div>
                                    </div>
                                    {% if item.image %}
                                    <img src="{{ item.image.url }}" alt="{{ item.title }}" class="w-full h-24 object-cover rounded mb-2">
                                    {% elif item.content_type == 'video' %}
                                    <div class="w-full h-24 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-500 text-xs">‚ñ∂Ô∏è –í–∏–¥–µ–æ</div>
                                    {% elif item.content_type == 'link' %}
                                    <div class="w-full h-24 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-500 text-xs">üîó –°—Å—ã–ª–∫–∞</div>
                                    {% elif item.content_type == 'gallery' %}
                                    <div class="w-full h-24 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-500 text-xs">üì∑ –ì–∞–ª–µ—Ä–µ—è</div>
                                    {% elif item.content_type == 'pdf' %}
                                    <div class="w-full h-24 bg-gray-200 rounded mb-2 flex items-center justify-center text-gray-500 text-xs">üìÑ PDF</div>
                                    {% elif item.content_type == 'text' %}
                                    <div class="w-full p-2 bg-gray-100 rounded mb-2 text-xs text-gray-600">{% if item.content_data and item.content_data.text %}{{ item.content_data.text|truncatewords:15 }}{% endif %}</div>
                                    {% endif %}
                                </div>
                        {% endfor %}
                    {% endif %}
                        </div>
                        <button onclick="addNewItem()" class="w-full px-2.5 py-1.5 text-xs bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition" type="button">
                            + –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É
                        </button>
                        <p class="mt-1 text-xs text-gray-500 text-center">üí° –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞</p>
                    </div>

                    <!-- –°–µ–∫—Ü–∏—è 5: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –±–ª–æ–∫–∏ -->
                    <div class="bg-white border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-lg">üß©</span>
                            <h2 class="text-base font-semibold text-gray-900">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –±–ª–æ–∫–∏</h2>
                        </div>
                        <div id="custom-blocks-list" class="space-y-2 mb-2" style="min-height: 60px;">
                            <!-- Custom blocks will be rendered here -->
                        </div>
                        <button onclick="addCustomBlock()" class="w-full px-2.5 py-1.5 text-xs bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition" type="button">
                            + –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                        </button>
                        <p class="mt-1 text-xs text-gray-500 text-center">üí° –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</p>
                    </div>
                    </div>
                </div>
            </div>
            <!-- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≤–Ω–∏–∑—É) -->
            <div class="px-4 py-2.5 border-t border-gray-200 flex-shrink-0 bg-white" style="box-shadow: 0 -2px 8px rgba(0,0,0,0.05);">
                <!-- –°—Ç–∞—Ç—É—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è -->
                <div class="flex items-center justify-between mb-2">
                    <span id="save-status-indicator" class="text-xs font-medium" style="color: #10b981;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
                    <div class="flex gap-1">
                        <button onclick="undoAction()" class="px-2 py-1 text-xs text-gray-600 hover:text-gray-800" title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)">
                            ‚Ü∂
                        </button>
                        <button onclick="redoAction()" class="px-2 py-1 text-xs text-gray-600 hover:text-gray-800" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Ctrl+Y)">
                            ‚Ü∑
                        </button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveToLibrary()" class="flex-1 px-4 py-2.5 bg-green-600 text-white font-semibold text-sm rounded-lg hover:bg-green-700 shadow-md transition-all duration-200">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
                    </button>
                </div>
                <div class="flex gap-2 mt-2">
                    <button onclick="exportPortfolioHTML()" class="flex-1 px-3 py-1.5 bg-gray-100 text-gray-700 font-medium text-xs rounded-lg hover:bg-gray-200 transition">
                        üì• HTML
                    </button>
                    <button onclick="exportPortfolioPDF()" class="flex-1 px-3 py-1.5 bg-gray-100 text-gray-700 font-medium text-xs rounded-lg hover:bg-gray-200 transition">
                        üìÑ PDF
                    </button>
                    <button onclick="viewPortfolio()" class="flex-1 px-3 py-1.5 bg-gray-100 text-gray-700 font-medium text-xs rounded-lg hover:bg-gray-200 transition">
                        üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                </div>
                <a href="/portfolios/" class="block mt-2 text-center text-sm text-indigo-600 hover:text-indigo-800">
                    üìö –ú–æ–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
                </a>
            </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –ñ–∏–≤–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ -->
    <div class="portfolio-preview-container">
        <div class="preview-wrapper" style="display: flex; flex-direction: column; height: 100%; width: 100%;">
            <!-- –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
            <div class="preview-header flex-shrink-0 border-b border-gray-100 px-3 py-1.5 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-1.5">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs font-medium text-gray-600">–ñ–∏–≤–æ–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
                    </div>
                    <span class="text-xs text-gray-400 hidden sm:inline">–ò–∑–º–µ–Ω–µ–Ω–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ</span>
                </div>
            </div>
            <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ - —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å -->
            <div class="preview-content flex-1 overflow-y-auto overflow-x-hidden" id="preview-container" style="padding: 1.25rem; -webkit-overflow-scrolling: touch; min-height: 0; display: flex; align-items: flex-start; justify-content: center;">
                <div class="preview-inner" style="width: 100%; max-width: 1200px;">
                    <div id="portfolio-preview" class="portfolio-preview w-full">
                        <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                        <div class="text-center py-20">
                            <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">üë§</span>
                            </div>
                            <p class="text-gray-400 text-sm">–ù–∞—á–Ω–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–µ–≤–∞</p>
                            <p class="text-gray-300 text-xs mt-1">–ò–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã -->
<div id="item-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white mb-10">
        <div class="mt-3">
            <h3 class="text-lg font-bold text-gray-900 mb-4" id="item-modal-title">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã *</label>
                    <input type="text" id="item-title" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Sheepify States" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="item-description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ä–∞–±–æ—Ç—É..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–§–æ—Ç–æ —Ä–∞–±–æ—Ç—ã *</label>
                    <input type="file" id="item-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 800x600px –∏–ª–∏ –±–æ–ª—å—à–µ</p>
                    <div id="item-image-preview" class="mt-3"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="url" id="item-link-url" placeholder="https://example.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞, –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "Live View"</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <select id="item-content-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="changeContentType()">
                        <option value="image" selected>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                        <option value="video">–í–∏–¥–µ–æ</option>
                        <option value="link">–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–µ–∫—Ç</option>
                        <option value="gallery">–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <input type="text" id="item-category" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
                    <input type="text" id="item-tags" placeholder="React, JavaScript, Design" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ -->
                <div id="content-type-forms">
                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                    <div id="content-form-image" class="content-form">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <input type="file" id="item-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <div id="item-image-preview" class="mt-2"></div>
                    </div>
                    
                    <!-- –í–∏–¥–µ–æ -->
                    <div id="content-form-video" class="content-form hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL –≤–∏–¥–µ–æ (YouTube/Vimeo) –∏–ª–∏ —Ñ–∞–π–ª</label>
                        <input type="url" id="item-video-url" placeholder="https://youtube.com/watch?v=..." class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                        <p class="text-xs text-gray-500 mb-2">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª:</p>
                        <input type="file" id="item-video-file" accept="video/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <div id="item-video-preview" class="mt-2"></div>
                    </div>
                    
                    <!-- –°—Å—ã–ª–∫–∞ -->
                    <div id="content-form-link" class="content-form hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL —Å—Å—ã–ª–∫–∏</label>
                        <input type="url" id="item-link-url" placeholder="https://example.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
                        <button type="button" onclick="fetchLinkPreview()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm mb-2">
                            –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–≤—å—é
                        </button>
                        <div id="item-link-preview" class="mt-2 p-3 bg-gray-50 rounded-lg hidden">
                            <img id="link-preview-image" src="" alt="Preview" class="w-full h-48 object-cover rounded mb-2">
                            <h4 id="link-preview-title" class="font-semibold"></h4>
                            <p id="link-preview-description" class="text-sm text-gray-600"></p>
                        </div>
                    </div>
                    
                    <!-- –ì–∞–ª–µ—Ä–µ—è -->
                    <div id="content-form-gallery" class="content-form hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏</label>
                        <input type="file" id="item-gallery-images" accept="image/*" multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <div id="item-gallery-preview" class="mt-2 grid grid-cols-3 gap-2"></div>
                    </div>
                    
                    <!-- PDF -->
                    <div id="content-form-pdf" class="content-form hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">PDF —Ñ–∞–π–ª</label>
                        <input type="file" id="item-pdf-file" accept="application/pdf" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <div id="item-pdf-preview" class="mt-2"></div>
                    </div>
                    
                    <!-- –¢–µ–∫—Å—Ç -->
                    <div id="content-form-text" class="content-form hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¢–µ–∫—Å—Ç (Markdown –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)</label>
                        <textarea id="item-text-content" rows="8" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ Markdown..." class="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-sm"></textarea>
                    </div>
                </div>
            </div>
            <input type="hidden" id="item-edit-id" value="">
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeItemModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="saveItem()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤ -->
<div id="custom-block-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white mb-10">
        <div class="mt-3">
            <h3 class="text-lg font-bold text-gray-900 mb-4" id="custom-block-modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –±–ª–æ–∫</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞) *</label>
                    <input type="text" id="custom-block-name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û –ø—Ä–æ–µ–∫—Ç–µ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ *</label>
                    <input type="text" id="custom-block-title" required placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="custom-block-description" rows="5" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –±–ª–æ–∫–∞..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="file" id="custom-block-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <div id="custom-block-image-preview" class="mt-3"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="setCustomBlockSize('full')" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-size-btn active bg-indigo-100" data-size="full">–ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞</button>
                        <button type="button" onclick="setCustomBlockSize('medium')" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-size-btn" data-size="medium">–°—Ä–µ–¥–Ω—è—è</button>
                        <button type="button" onclick="setCustomBlockSize('narrow')" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-size-btn" data-size="narrow">–£–∑–∫–∞—è</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                    <select id="custom-block-layout" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="image-right" selected>–¢–µ–∫—Å—Ç —Å–ª–µ–≤–∞, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</option>
                        <option value="text-only">–¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç (–±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π layout: —Ç–µ–∫—Å—Ç —Å–ª–µ–≤–∞, –±–æ–ª—å—à–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="setCustomBlockAlign('left')" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-align-btn" data-align="left">–°–ª–µ–≤–∞</button>
                        <button type="button" onclick="setCustomBlockAlign('center')" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-align-btn active bg-indigo-100" data-align="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</button>
                        <button type="button" onclick="setCustomBlockAlign('right')" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-align-btn" data-align="right">–°–ø—Ä–∞–≤–∞</button>
                    </div>
                </div>
                
                <!-- Custom Block Advanced Settings -->
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h4>
                    
                    <!-- Title Size Control -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –†–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞
                            <span id="custom-block-title-size-value" class="text-xs text-gray-500 ml-2">(24px)</span>
                        </label>
                        <div class="flex gap-2 mb-2">
                            <button type="button" onclick="setCustomBlockTitleSize('small')" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-title-size-btn" data-size="small">S</button>
                            <button type="button" onclick="setCustomBlockTitleSize('medium')" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-title-size-btn active bg-indigo-100" data-size="medium">M</button>
                            <button type="button" onclick="setCustomBlockTitleSize('large')" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-title-size-btn" data-size="large">L</button>
                            <button type="button" onclick="setCustomBlockTitleSize('xlarge')" class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded-md hover:bg-gray-50 custom-block-title-size-btn" data-size="xlarge">XL</button>
                        </div>
                        <input type="range" id="custom-block-title-size" min="16" max="48" value="24" step="2" class="w-full" oninput="updateCustomBlockTitleSizeValue(this.value)">
                    </div>
                    
                    <!-- Image Size Ratio -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            <span id="custom-block-image-ratio-value" class="text-xs text-gray-500 ml-2">(55%)</span>
                        </label>
                        <input type="range" id="custom-block-image-ratio" min="50" max="70" value="55" step="2" class="w-full" oninput="updateCustomBlockImageRatioValue(this.value)">
                        <p class="text-xs text-gray-500 mt-1">–ü—Ä–æ—Ü–µ–Ω—Ç —à–∏—Ä–∏–Ω—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ—Å—Ç–∞–ª—å–Ω–æ–µ - —Ç–µ–∫—Å—Ç). –†–µ—Ñ–µ—Ä–µ–Ω—Å: 45% —Ç–µ–∫—Å—Ç / 55% –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                    </div>
                    
                    <!-- Block Padding -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –û—Ç—Å—Ç—É–ø—ã –±–ª–æ–∫–∞
                            <span id="custom-block-padding-value" class="text-xs text-gray-500 ml-2">(12px)</span>
                        </label>
                        <input type="range" id="custom-block-padding" min="8" max="24" value="12" step="2" class="w-full" oninput="updateCustomBlockPaddingValue(this.value)">
                        <p class="text-xs text-gray-500 mt-1">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–µ —Å–µ–∫—Ü–∏–∏)</p>
                    </div>
                    
                    <!-- Block Background Color -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ –±–ª–æ–∫–∞</label>
                        <div class="flex gap-2 items-center">
                            <input type="color" id="custom-block-bg-color" value="#f9fafb" class="w-16 h-10 border border-gray-300 rounded cursor-pointer" onchange="updateCustomBlockBgColorPreview(); updatePreview();">
                            <input type="text" id="custom-block-bg-color-text" value="#f9fafb" placeholder="#f9fafb" class="flex-1 px-3 py-2 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" onchange="updateCustomBlockBgColorFromText(); updatePreview();">
                            <button type="button" onclick="resetCustomBlockBgColor()" class="px-3 py-2 text-xs bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" title="–°–±—Ä–æ—Å–∏—Ç—å –∫ —Ü–≤–µ—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é">
                                ‚Ü∫
                            </button>
                        </div>
                        <div id="custom-block-bg-color-preview" class="mt-2 w-full h-8 rounded border border-gray-300" style="background: #f9fafb;"></div>
                        <p class="text-xs text-gray-500 mt-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞</p>
                    </div>
                </div>
            </div>
            <input type="hidden" id="custom-block-edit-id" value="">
            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="closeCustomBlockModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="saveCustomBlock()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="/static/js/portfolio-service.js"></script>
<script src="/static/js/portfolio-export.js"></script>
<script src="/static/js/portfolio-renderer.js"></script>
<script>
let selectedTemplate = {% if portfolio.template %}{{ portfolio.template.id }}{% else %}null{% endif %};
let customColors = {
    primary: {% if portfolio.color_scheme and portfolio.color_scheme.primary_color %}'{{ portfolio.color_scheme.primary_color|escapejs }}'{% else %}'#4f46e5'{% endif %},
    secondary: {% if portfolio.color_scheme and portfolio.color_scheme.secondary_color %}'{{ portfolio.color_scheme.secondary_color|escapejs }}'{% else %}'#7c3aed'{% endif %},
    accent: {% if portfolio.color_scheme and portfolio.color_scheme.accent_color %}'{{ portfolio.color_scheme.accent_color|escapejs }}'{% else %}'#ec4899'{% endif %},
    text: {% if portfolio.color_scheme and portfolio.color_scheme.text_color %}'{{ portfolio.color_scheme.text_color|escapejs }}'{% else %}'#ffffff'{% endif %},
    background: {% if portfolio.color_scheme and portfolio.color_scheme.background_color %}'{{ portfolio.color_scheme.background_color|escapejs }}'{% else %}'#1e1b4b'{% endif %}
};
let designSettings = {% if portfolio.design_settings %}{{ portfolio.design_settings|safe }}{% else %}null{% endif %};
if (designSettings === null || designSettings === undefined) {
    designSettings = {};
} else if (typeof designSettings === 'string') {
    try {
        designSettings = JSON.parse(designSettings);
    } catch(e) {
        designSettings = {};
    }
}
// Custom blocks array
let customBlocks = [];
// Initialize custom blocks from saved data
try {
    {% if portfolio.design_settings and portfolio.design_settings.custom_blocks %}
    customBlocks = {{ portfolio.design_settings.custom_blocks|safe }};
    {% endif %}
} catch(e) {
    console.warn('Error loading custom blocks:', e);
}
// Make available globally
window.customBlocks = customBlocks;

let portfolioItems = [
    {% for item in portfolio.items.all %}
    {
        id: {{ item.id }},
        title: "{{ item.title|escapejs }}",
        description: "{{ item.description|escapejs }}",
        image: {% if item.image %}"{{ item.image.url|escapejs }}"{% else %}null{% endif %},
        content_type: {% if item.content_type %}"{{ item.content_type|escapejs }}"{% else %}"image"{% endif %},
        content_data: {% if item.content_data %}{{ item.content_data|safe }}{% else %}{}{% endif %},
        category: {% if item.category %}"{{ item.category|escapejs }}"{% else %}""{% endif %},
        tags: {% if item.tags %}{{ item.tags|safe }}{% else %}[]{% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', async function() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.body.classList.add('portfolio-editor-page');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è color picker
    initColorPickers();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∏–∑–∞–π–Ω–∞
    initDesignSettings();
    
    // CRITICAL: Load portfolio FIRST before rendering default state
    // Check if we need to load a saved portfolio
    const urlParams = new URLSearchParams(window.location.search);
    const portfolioId = urlParams.get('portfolio');
    let portfolioLoaded = false;
    
    if (portfolioId && window.portfolioService) {
        try {
            const portfolio = window.portfolioService.getPortfolio(portfolioId);
            if (portfolio && portfolio.editorState) {
                // Load portfolio data BEFORE rendering
                window.portfolioService.loadPortfolioIntoEditor(portfolio);
                window.portfolioService.currentPortfolioId = portfolioId;
                portfolioLoaded = true;
            } else {
                console.warn('Portfolio not found:', portfolioId);
            }
        } catch (error) {
            console.error('Error loading portfolio:', error);
            showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ' + error.message, true);
        }
    }
    
    // Only render default state if no portfolio was loaded
    if (!portfolioLoaded) {
        // Initialize with default template if specified
        if (selectedTemplate) {
            selectTemplate(selectedTemplate);
        }
        
        // Initialize with default data
        renderItems();
        renderCustomBlocks();
    }
    
    // Initialize sortable after rendering
    initSortable();
    
    // Load font after state is loaded
    const fontFamily = document.getElementById('text-font-family')?.value || 'Inter';
    if (window.PortfolioRenderer && fontFamily !== 'Inter') {
        await window.PortfolioRenderer.loadFont(fontFamily);
    }
    
    // Update preview AFTER all data is loaded
    // CRITICAL: Wait a bit to ensure all DOM updates (especially backgroundType) are complete
    setTimeout(() => {
        updatePreview();
    }, portfolioLoaded ? 100 : 0);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    document.getElementById('avatar-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('avatar-preview');
                if (preview.tagName === 'IMG') {
                    preview.src = e.target.result;
                } else {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Avatar" class="w-20 h-20 rounded-full object-cover">`;
                }
                updatePreview();
            };
            reader.readAsDataURL(file);
        }
    });
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ + –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    function markChanged() {
        if (window.portfolioService) {
            window.portfolioService.markUnsaved();
            window.portfolioService.saveStatus = 'unsaved';
            window.portfolioService.updateSaveStatus();
            
            // Autosave after delay
            const portfolioData = window.portfolioService.serializeEditorState();
            portfolioData.title = document.getElementById('portfolio-name')?.value || '–ú–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ';
            const urlParams = new URLSearchParams(window.location.search);
            const portfolioId = urlParams.get('portfolio');
            if (portfolioId) {
                portfolioData.id = portfolioId;
                window.portfolioService.autosave(portfolioData);
            }
        }
    }
    
    document.getElementById('portfolio-name')?.addEventListener('input', function() {
        updatePreview();
        markChanged();
    });
    document.getElementById('portfolio-profession')?.addEventListener('input', function() {
        updatePreview();
        markChanged();
    });
    document.getElementById('portfolio-description')?.addEventListener('input', function() {
        updatePreview();
        markChanged();
    });
    ['portfolio-phone', 'portfolio-email', 'portfolio-website', 'portfolio-location'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', function() {
            updatePreview();
            markChanged();
        });
    });
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('skill-input') || 
            e.target.classList.contains('social-url') ||
            e.target.classList.contains('color-hex-input')) {
            updatePreview();
        }
    });
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–æ–≤ (—Å—Ç—Ä–æ–≥–∞—è —Å–∏—Å—Ç–µ–º–∞: Primary, Accent, Background, Card Background)
    ['color-primary', 'color-accent', 'color-background', 'color-background-2', 'color-card-background'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', function() {
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –ø–æ–ª–µ–º
                const textInput = document.getElementById(id + '-text');
                if (textInput) textInput.value = this.value;
                // –û–±–Ω–æ–≤–∏—Ç—å customColors
                if (id === 'color-primary') customColors.primary = this.value;
                else if (id === 'color-accent') customColors.accent = this.value;
                else if (id === 'color-background') {
                    customColors.background = this.value;
                    // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é —Ñ–æ–Ω–∞
                    const preview = document.getElementById('background-preview');
                    if (preview) {
                        const bgType = document.getElementById('background-type')?.value || 'solid';
                        if (bgType === 'gradient') {
                            const bg2 = document.getElementById('color-background-2')?.value || '#f3f4f6';
                            preview.style.background = `linear-gradient(135deg, ${this.value} 0%, ${bg2} 100%)`;
                        } else {
                            preview.style.background = this.value;
                        }
                    }
                    // CRITICAL: Update preview and mark as changed to save
                    updatePreview();
                    markChanged();
                }
                else if (id === 'color-background-2') {
                    customColors.background2 = this.value;
                    // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
                    const gradientPreview = document.getElementById('gradient-preview');
                    if (gradientPreview) {
                        const bg1 = document.getElementById('color-background')?.value || '#ffffff';
                        gradientPreview.style.background = `linear-gradient(135deg, ${bg1} 0%, ${this.value} 100%)`;
                    }
                    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–∏—Ç—å background-preview –µ—Å–ª–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω
                    const preview = document.getElementById('background-preview');
                    if (preview) {
                        const bgType = document.getElementById('background-type')?.value || 'solid';
                        if (bgType === 'gradient') {
                            const bg1 = document.getElementById('color-background')?.value || '#ffffff';
                            preview.style.background = `linear-gradient(135deg, ${bg1} 0%, ${this.value} 100%)`;
                        }
                    }
                    // CRITICAL: Update preview and mark as changed to save
                    updatePreview();
                    markChanged();
                }
                else if (id === 'color-card-background') {
                    customColors.cardBackground = this.value;
                    // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é —Ü–≤–µ—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
                    const cardPreview = document.getElementById('card-background-preview');
                    if (cardPreview) {
                        cardPreview.style.background = this.value;
                    }
                }
                // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
                if (document.getElementById('custom-colors-section') && !document.getElementById('custom-colors-section').classList.contains('hidden')) {
                    validateColorContrast();
                }
                updatePreview();
                markChanged();
            });
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π —Ü–≤–µ—Ç–æ–≤
    ['color-primary-text', 'color-accent-text', 'color-background-text', 'color-background-2-text', 'color-card-background-text'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', function() {
                if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
                    const colorInputId = id.replace('-text', '');
                    const colorInput = document.getElementById(colorInputId);
                    if (colorInput) {
                        colorInput.value = this.value;
                        colorInput.dispatchEvent(new Event('input'));
                        // –û–±–Ω–æ–≤–∏—Ç—å customColors –∏ –ø—Ä–µ–≤—å—é —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏–µ input
                    }
                }
            });
        }
    });
    
    // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('social-platform')) {
            updatePreview();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è range —Å–ª–∞–π–¥–µ—Ä–æ–≤
    ['design-h1-size', 'design-body-size', 'design-padding', 'design-border-radius'].forEach(id => {
        const slider = document.getElementById(id);
        const valueDisplay = document.getElementById(id + '-value');
        if (slider && valueDisplay) {
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value + 'px';
                updatePreview();
            });
        }
    });
    
    ['design-font-family', 'design-box-shadow'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updatePreview);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–∫—Å—Ç–∞
    ['text-font-family', 'text-font-weight', 'text-h1-size', 'text-h2-size', 'text-body-size'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (id.includes('size')) {
                const valueDisplay = document.getElementById(id + '-value');
                el.addEventListener('input', function() {
                    if (valueDisplay) valueDisplay.textContent = this.value + 'px';
                    updatePreview();
                });
            } else if (id === 'text-font-family') {
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å —à—Ä–∏—Ñ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
                el.addEventListener('change', async function() {
                    const fontFamily = this.value;
                    if (window.PortfolioRenderer) {
                        await window.PortfolioRenderer.loadFont(fontFamily);
                    }
                    updatePreview();
                });
            } else {
                el.addEventListener('change', updatePreview);
            }
        }
    });
    
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è line-height –∏ letter-spacing
    ['text-line-height', 'text-letter-spacing'].forEach(id => {
        const el = document.getElementById(id);
        const valueDisplay = document.getElementById(id + '-value');
        if (el) {
            el.addEventListener('input', function() {
                if (valueDisplay) {
                    if (id === 'text-letter-spacing') {
                        valueDisplay.textContent = this.value + 'px';
                    } else {
                        valueDisplay.textContent = parseFloat(this.value).toFixed(1);
                    }
                }
                updatePreview();
            });
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã –∞–≤–∞—Ç–∞—Ä–∞
    document.getElementById('avatar-shape')?.addEventListener('change', updatePreview);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–∏–ø–∞ —Ñ–æ–Ω–∞ - CRITICAL: Must save backgroundType
    document.getElementById('background-type')?.addEventListener('change', function() {
        const gradientControl = document.getElementById('gradient-opacity-control');
        const preview = document.getElementById('background-preview');
        const gradientPreview = document.getElementById('gradient-preview');
        const bg1 = document.getElementById('color-background')?.value || '#ffffff';
        const bg2 = document.getElementById('color-background-2')?.value || '#f3f4f6';
        
        if (this.value === 'gradient') {
            gradientControl?.classList.remove('hidden');
            if (preview) {
                preview.style.background = `linear-gradient(135deg, ${bg1} 0%, ${bg2} 100%)`;
            }
            if (gradientPreview) {
                gradientPreview.style.background = `linear-gradient(135deg, ${bg1} 0%, ${bg2} 100%)`;
            }
        } else {
            gradientControl?.classList.add('hidden');
            if (preview) {
                preview.style.background = bg1;
            }
        }
        // CRITICAL: Update preview and mark as changed to save backgroundType
        updatePreview();
        markChanged();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–∞–∫–µ—Ç–∞
    document.getElementById('layout-type')?.addEventListener('change', updatePreview);
    document.getElementById('item-preview-size')?.addEventListener('input', function() {
        const valueDisplay = document.getElementById('item-preview-size-value');
        if (valueDisplay) valueDisplay.textContent = this.value + 'px';
        updatePreview();
    });
    document.getElementById('block-spacing')?.addEventListener('input', function() {
        const valueDisplay = document.getElementById('block-spacing-value');
        if (valueDisplay) valueDisplay.textContent = this.value + 'px';
        updatePreview();
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –±–ª–æ–∫–æ–≤
    ['block-contacts', 'block-skills', 'block-experience', 'block-education', 'block-certificates', 'block-languages', 'block-works'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', updatePreview);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ü–≤–µ—Ç–æ–≤ (–≥—Ä–∞–¥–∏–µ–Ω—Ç—ã) - —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    setTimeout(() => {
        document.querySelector('.text-align-btn[data-align="center"]')?.classList.add('active', 'bg-indigo-100');
        document.querySelector('.grid-cols-btn[data-cols="2"]')?.classList.add('active', 'bg-indigo-100');
    }, 100);
    
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
    setTimeout(() => {
        document.querySelectorAll('.skill-input').forEach(input => {
            if (!input.hasAttribute('data-listener-added')) {
                input.addEventListener('input', updatePreview);
                input.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.social-url').forEach(input => {
            if (!input.hasAttribute('data-listener-added')) {
                input.addEventListener('input', updatePreview);
                input.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.social-platform').forEach(select => {
            if (!select.hasAttribute('data-listener-added')) {
                select.addEventListener('change', updatePreview);
                select.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.experience-item input, .experience-item textarea').forEach(input => {
            if (!input.hasAttribute('data-listener-added')) {
                input.addEventListener('input', updatePreview);
                input.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.education-item input, .education-item textarea').forEach(input => {
            if (!input.hasAttribute('data-listener-added')) {
                input.addEventListener('input', updatePreview);
                input.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.certificate-item input').forEach(input => {
            if (!input.hasAttribute('data-listener-added')) {
                input.addEventListener('input', updatePreview);
                input.addEventListener('change', updatePreview);
                input.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.lang-language').forEach(input => {
            if (!input.hasAttribute('data-listener-added')) {
                input.addEventListener('input', updatePreview);
                input.setAttribute('data-listener-added', 'true');
            }
        });
        document.querySelectorAll('.lang-level').forEach(select => {
            if (!select.hasAttribute('data-listener-added')) {
                select.addEventListener('change', updatePreview);
                select.setAttribute('data-listener-added', 'true');
            }
        });
    }, 200);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è email
    document.getElementById('portfolio-email')?.addEventListener('blur', function() {
        const email = this.value;
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            this.style.borderColor = '#ef4444';
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email');
        } else {
            this.style.borderColor = '';
        }
    });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è URL
    ['portfolio-website'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('blur', function() {
                const url = this.value;
                if (url && !/^https?:\/\/.+/.test(url)) {
                    if (url && !url.startsWith('http')) {
                        this.value = 'https://' + url;
                    }
                }
            });
        }
    });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è URL —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π
    document.addEventListener('blur', function(e) {
        if (e.target && e.target.classList.contains('social-url')) {
            const url = e.target.value;
            if (url && !/^https?:\/\/.+/.test(url)) {
                e.target.style.borderColor = '#ef4444';
            } else {
                e.target.style.borderColor = '';
            }
        }
    }, true);
});

function selectTemplate(templateId) {
    selectedTemplate = templateId;
    document.querySelectorAll('.template-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-template-id="${templateId}"]`).classList.add('selected');
    updatePreview();
}

function updatePreview() {
    try {
        const name = document.getElementById('portfolio-name')?.value || '–ú–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ';
        const profession = document.getElementById('portfolio-profession')?.value || '';
        const description = document.getElementById('portfolio-description')?.value || '';
        const avatar = document.getElementById('avatar-preview');
        const avatarSrc = avatar && avatar.tagName === 'IMG' ? avatar.src : (avatar && avatar.querySelector('img') ? avatar.querySelector('img').src : '');
    
    // –ü–æ–ª—É—á–∏—Ç—å —Ü–≤–µ—Ç–∞ –∏–∑ color picker (—Å—Ç—Ä–æ–≥–∞—è —Å–∏—Å—Ç–µ–º–∞: Primary, Accent, Background)
    const primaryColor = document.getElementById('color-primary')?.value || customColors.primary || '#2563EB';
    const accentColor = document.getElementById('color-accent')?.value || customColors.accent || '#1E40AF';
    const bgColor = document.getElementById('color-background')?.value || customColors.background || '#ffffff';
    const backgroundType = document.getElementById('background-type')?.value || 'solid';
    const bgColor2 = document.getElementById('color-background-2')?.value || '#f3f4f6';
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–æ–Ω–∞ (WCAG)
    const textColor = getOptimalTextColor(bgColor);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ü–≤–µ—Ç–∞ –≤–∫–ª—é—á–µ–Ω—ã)
    const customColorsSection = document.getElementById('custom-colors-section');
    if (customColorsSection && !customColorsSection.classList.contains('hidden')) {
        try {
            const contrastCheck = validateColorContrast();
            if (contrastCheck && !contrastCheck.isValid) {
                console.warn('WCAG contrast validation failed. Please adjust colors to meet accessibility requirements.');
            }
        } catch (error) {
            console.error('Error validating color contrast:', error);
        }
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞
    const textFontFamily = document.getElementById('text-font-family')?.value || 'Inter';
    const textFontWeight = document.getElementById('text-font-weight')?.value || '400';
    const textLineHeight = document.getElementById('text-line-height')?.value || '1.6';
    const textLetterSpacing = document.getElementById('text-letter-spacing')?.value || '0';
    const textH1Size = document.getElementById('text-h1-size')?.value || '48';
    const textH2Size = document.getElementById('text-h2-size')?.value || '24';
    const textBodySize = document.getElementById('text-body-size')?.value || '16';
    const textAlign = document.querySelector('.text-align-btn.active')?.dataset.align || 'center';
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
    const avatarShape = document.getElementById('avatar-shape')?.value || 'circle';
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–∫–µ—Ç–∞
    const cardStyle = document.querySelector('.card-style-btn.active')?.dataset.style || 'elevated';
    const borderRadiusPreset = document.querySelector('.border-radius-btn.active')?.dataset.radius || 'medium';
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞–∫–µ—Ç–∞
    const layoutType = document.getElementById('layout-type')?.value || 'centered';
    const gridColumns = document.querySelector('.grid-cols-btn.active')?.dataset.cols || '2';
    const itemPreviewSize = document.getElementById('item-preview-size')?.value || '128';
    const blockSpacing = document.getElementById('block-spacing')?.value || '24';
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –±–ª–æ–∫–æ–≤
    const showContacts = document.getElementById('block-contacts')?.checked !== false;
    const showSkills = document.getElementById('block-skills')?.checked !== false;
    const showExperience = document.getElementById('block-experience')?.checked !== false;
    const showEducation = document.getElementById('block-education')?.checked !== false;
    const showCertificates = document.getElementById('block-certificates')?.checked !== false;
    const showLanguages = document.getElementById('block-languages')?.checked !== false;
    const showWorks = document.getElementById('block-works')?.checked !== false;
    // Get custom blocks from global variable
    const customBlocks = window.customBlocks || [];
    
    // backgroundType —É–∂–µ –ø–æ–ª—É—á–µ–Ω –≤—ã—à–µ (—Å—Ç—Ä–æ–∫–∞ 1145), backgroundOpacity –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∑–∞–π–Ω–∞ (—Å—Ç–∞—Ä—ã–µ, –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    const fontFamily = textFontFamily;
    const h1Size = textH1Size;
    const bodySize = textBodySize;
    const padding = document.getElementById('design-padding')?.value || '32';
    const borderRadius = document.getElementById('design-border-radius')?.value || '8';
    const boxShadow = document.getElementById('design-box-shadow')?.value || 'sm';
    
    const shadowClasses = {
        none: '',
        sm: 'shadow-sm',
        md: 'shadow-md',
        lg: 'shadow-lg',
        xl: 'shadow-2xl'
    };
    
    // –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    const phone = document.getElementById('portfolio-phone')?.value || '';
    const email = document.getElementById('portfolio-email')?.value || '';
    const website = document.getElementById('portfolio-website')?.value || '';
    const location = document.getElementById('portfolio-location')?.value || '';
    
    // –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏
    const socialLinks = {};
    document.querySelectorAll('.social-link-item').forEach(item => {
        const platformEl = item.querySelector('.social-platform');
        const urlEl = item.querySelector('.social-url');
        if (platformEl && urlEl && urlEl.value) {
            socialLinks[platformEl.value] = urlEl.value;
        }
    });
    
    // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–≤—ã–∫–∏
    const skills = Array.from(document.querySelectorAll('.skill-input')).map(input => input?.value || '').filter(v => v && v.trim());
    
    // –ü–æ–ª—É—á–∏—Ç—å –æ–ø—ã—Ç —Ä–∞–±–æ—Ç—ã
    const experience = Array.from(document.querySelectorAll('.experience-item')).map(item => ({
        position: item.querySelector('.exp-position')?.value || '',
        company: item.querySelector('.exp-company')?.value || '',
        period: item.querySelector('.exp-period')?.value || '',
        description: item.querySelector('.exp-description')?.value || ''
    })).filter(exp => exp.position || exp.company);
    
    // –ü–æ–ª—É—á–∏—Ç—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ
    const education = Array.from(document.querySelectorAll('.education-item')).map(item => {
        const instEl = item.querySelector('.edu-institution');
        const specEl = item.querySelector('.edu-specialty');
        const periodEl = item.querySelector('.edu-period');
        const descEl = item.querySelector('.edu-description');
        return {
            institution: instEl?.value || '',
            specialty: specEl?.value || '',
            period: periodEl?.value || '',
            description: descEl?.value || ''
        };
    }).filter(edu => edu.institution);
    
    // –ü–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    const certificates = Array.from(document.querySelectorAll('.certificate-item')).map(item => {
        const nameEl = item.querySelector('.cert-name');
        const orgEl = item.querySelector('.cert-organization');
        const dateEl = item.querySelector('.cert-date');
        const linkEl = item.querySelector('.cert-link');
        return {
            name: nameEl?.value?.trim() || '',
            organization: orgEl?.value?.trim() || '',
            date: dateEl?.value || '',
            link: linkEl?.value?.trim() || ''
        };
    }).filter(cert => cert.name);
    
    // –ü–æ–ª—É—á–∏—Ç—å —è–∑—ã–∫–∏
    const languages = Array.from(document.querySelectorAll('.language-item')).map(item => {
        const langEl = item.querySelector('.lang-language');
        const levelEl = item.querySelector('.lang-level');
        return {
            language: langEl?.value?.trim() || '',
            level: levelEl?.value || 'beginner'
        };
    }).filter(lang => lang.language);
    
    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ–æ–Ω (—Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞: solid –∏–ª–∏ linear gradient, –º–∞–∫—Å. 2 —Ü–≤–µ—Ç–∞)
    // CRITICAL: Ensure bgColor2 has a fallback for gradients
    const gradientColor2 = bgColor2 || '#f3f4f6';
    let backgroundStyle = '';
    if (backgroundType === 'gradient' && bgColor) {
        backgroundStyle = `background: linear-gradient(135deg, ${bgColor} 0%, ${gradientColor2} 100%);`;
    } else {
        backgroundStyle = `background: ${bgColor || '#ffffff'};`;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∏–ª—å –º–∞–∫–µ—Ç–∞
    let layoutStyle = '';
    if (layoutType === 'left-right') {
        layoutStyle = 'display: flex; align-items: center; gap: 32px;';
    } else if (layoutType === 'top-bottom') {
        layoutStyle = 'display: flex; flex-direction: column;';
    } else if (layoutType === 'cards') {
        layoutStyle = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;';
    } else if (layoutType === 'list') {
        layoutStyle = 'display: flex; flex-direction: column; gap: 16px;';
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–∏–∑–∞–π–Ω–∞ (—Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞)
    const fixedBgColor = backgroundStyle; // –§–æ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (solid –∏–ª–∏ gradient)
    const fixedPrimaryColor = primaryColor; // Primary color –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –∫–Ω–æ–ø–æ–∫, –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const fixedAccentColor = accentColor; // Accent color –¥–ª—è –∏–∫–æ–Ω–æ–∫, —Å—Å—ã–ª–æ–∫, —Ç–µ–≥–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–º–µ—Ä–µ–Ω–Ω–æ)
    const fixedTextColor = textColor; // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ (WCAG)
    const isLightBg = getLuminance(bgColor) > 0.5;
    // Card background color (—Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫/—Å–µ–∫—Ü–∏–π)
    const cardBgInput = document.getElementById('color-card-background');
    let fixedCardBg = cardBgInput?.value;
    if (!fixedCardBg) {
        // Auto-detect based on background if not set
        fixedCardBg = isLightBg ? '#f9fafb' : '#374151';
    }
    // Card text color (—Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–æ–Ω–∞ –∫–∞—Ä—Ç–æ—á–µ–∫)
    const fixedCardTextColor = getOptimalTextColor(fixedCardBg);
    
    // Border radius presets
    const borderRadiusMap = {
        'none': '0px',
        'small': '4px',
        'medium': '12px',
        'large': '24px'
    };
    const fixedBorderRadius = borderRadiusMap[borderRadiusPreset] || '12px';
    
    // Card style (flat or elevated)
    const fixedShadow = cardStyle === 'elevated' 
        ? '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)' 
        : 'none';
    
    // Avatar shape styles
    const avatarBorderRadiusMap = {
        'circle': '50%',
        'rounded': '16px',
        'square': '0px'
    };
    const avatarBorderRadius = avatarBorderRadiusMap[avatarShape] || '50%';
    
    const preview = document.getElementById('portfolio-preview');
    if (!preview) {
        console.error('Preview container not found!');
        // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
            const retryPreview = document.getElementById('portfolio-preview');
            if (retryPreview) {
                updatePreview();
            }
        }, 100);
        return;
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    preview.innerHTML = `
        <div style="${fixedBgColor} color: ${fixedTextColor}; padding: ${padding}px; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow}; max-width: 1200px; margin: 0 auto; width: 100%; box-sizing: border-box; word-wrap: break-word; overflow-wrap: break-word; overflow-x: hidden;" class="rounded-lg">
            <!-- Hero Block -->
            <div style="text-align: ${textAlign}; margin-bottom: ${blockSpacing}px; padding: 40px 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                ${avatarSrc ? `<img src="${avatarSrc}" alt="Avatar" style="width: 140px; height: 140px; border-radius: ${avatarBorderRadius}; object-fit: cover; object-position: center; border: 4px solid ${fixedPrimaryColor}; margin-bottom: 20px; display: block; ${textAlign === 'center' ? 'margin-left: auto; margin-right: auto;' : textAlign === 'right' ? 'margin-left: auto; margin-right: 0;' : 'margin-left: 0; margin-right: auto;'}; box-shadow: ${fixedShadow}; vertical-align: middle;">` : `<div style="width: 140px; height: 140px; border-radius: ${avatarBorderRadius}; background: ${fixedPrimaryColor}; margin: ${textAlign === 'center' ? '0 auto 20px;' : textAlign === 'right' ? '0 0 20px auto;' : '0 0 20px 0;'}; box-shadow: ${fixedShadow};"></div>`}
                <h1 style="font-size: ${textH1Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 12px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${name}</h1>
                ${profession ? `<p style="font-size: ${parseInt(textH2Size)}px; font-family: '${textFontFamily}', sans-serif; margin-top: 8px; margin-bottom: 16px; color: ${fixedCardTextColor}; font-weight: ${textFontWeight}; opacity: 0.8; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${profession}</p>` : ''}
                ${description ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin-top: 12px; ${textAlign === 'center' ? 'max-width: 700px; margin-left: auto; margin-right: auto;' : ''} color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px; opacity: 0.9;">${description}</p>` : ''}
            </div>
            
            ${showContacts && (phone || email || website || location || Object.keys(socialLinks).length > 0) ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 16px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2>
                    ${phone ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 8px 0; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">üìû ${phone}</p>` : ''}
                    ${email ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 8px 0; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">üìß ${email}</p>` : ''}
                    ${website ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 8px 0; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">üåê <a href="${website}" target="_blank" style="color: ${fixedAccentColor}; text-decoration: none; border-bottom: 1px solid ${fixedAccentColor};">${website}</a></p>` : ''}
                    ${location ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 8px 0; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">üìç ${location}</p>` : ''}
                    ${Object.keys(socialLinks).length > 0 ? `<div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;">${Object.entries(socialLinks).map(([platform, url]) => `<a href="${url}" target="_blank" style="padding: 6px 12px; background: ${fixedAccentColor}; color: white; border-radius: 6px; text-decoration: none; font-size: ${parseInt(textBodySize) * 0.9}px; font-family: '${textFontFamily}', sans-serif;">${platform}</a>`).join('')}</div>` : ''}
                </div>
            ` : ''}
            
            ${showSkills && skills.length > 0 ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 16px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–ù–∞–≤—ã–∫–∏</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${skills.map(skill => `<span style="padding: 10px 18px; background: ${fixedPrimaryColor}; color: white; border-radius: ${fixedBorderRadius}; font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${skill}</span>`).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${showExperience && experience.length > 0 ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 20px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã</h2>
                    ${experience.map(exp => `
                        <div style="margin-bottom: 20px; padding: 20px; background: ${isLightBg ? 'white' : '#4B5563'}; border-left: 4px solid ${fixedPrimaryColor}; border-radius: ${fixedBorderRadius}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h3 style="font-size: ${parseInt(textH2Size) * 0.95}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 8px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${exp.position || '–î–æ–ª–∂–Ω–æ—Å—Ç—å'}</h3>
                            <p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 6px 0; color: ${fixedCardTextColor}; font-weight: ${textFontWeight}; opacity: 0.8; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${exp.company || ''} ${exp.period ? `‚Ä¢ ${exp.period}` : ''}</p>
                            ${exp.description ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin-top: 12px; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${exp.description}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${showEducation && education.length > 0 ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 20px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h2>
                    ${education.map(edu => `
                        <div style="margin-bottom: 20px; padding: 20px; background: ${isLightBg ? 'white' : '#4B5563'}; border-left: 4px solid ${fixedPrimaryColor}; border-radius: ${fixedBorderRadius}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h3 style="font-size: ${parseInt(textH2Size) * 0.95}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 8px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${edu.institution || '–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ'}</h3>
                            <p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 6px 0; color: ${fixedCardTextColor}; font-weight: ${textFontWeight}; opacity: 0.8; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${edu.specialty || ''} ${edu.period ? `‚Ä¢ ${edu.period}` : ''}</p>
                            ${edu.description ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin-top: 12px; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${edu.description}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${showCertificates && certificates.length > 0 ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 20px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã</h2>
                    ${certificates.map(cert => `
                        <div style="margin-bottom: 20px; padding: 20px; background: ${isLightBg ? 'white' : '#4B5563'}; border-left: 4px solid ${fixedPrimaryColor}; border-radius: ${fixedBorderRadius}; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                            <h3 style="font-size: ${parseInt(textH2Size) * 0.95}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 8px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${cert.name || '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç'}</h3>
                            <p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin: 6px 0; color: ${fixedCardTextColor}; font-weight: ${textFontWeight}; opacity: 0.8; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${cert.organization || ''} ${cert.date ? `‚Ä¢ ${cert.date}` : ''}</p>
                            ${cert.link ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; margin-top: 8px;"><a href="${cert.link}" target="_blank" style="color: ${fixedAccentColor}; text-decoration: none; border-bottom: 1px solid ${fixedAccentColor};">üîó –°—Å—ã–ª–∫–∞ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</a></p>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${showLanguages && languages.length > 0 ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 16px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–Ø–∑—ã–∫–∏</h2>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${languages.map(lang => {
                            const levelNames = { beginner: '–ù–∞—á–∞–ª—å–Ω—ã–π', intermediate: '–°—Ä–µ–¥–Ω–∏–π', advanced: '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π', native: '–†–æ–¥–Ω–æ–π' };
                            return `<span style="padding: 10px 18px; background: ${fixedPrimaryColor}; color: white; border-radius: ${fixedBorderRadius}; font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; box-shadow: 0 2px 4px rgba(0,0,0,0.1); line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${lang.language} (${levelNames[lang.level] || lang.level})</span>`;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${showWorks && portfolioItems.length > 0 ? `
                <div style="margin-bottom: ${blockSpacing}px; padding: 24px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow};">
                    <h2 style="font-size: ${textH2Size}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 24px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">–ú–æ–∏ —Ä–∞–±–æ—Ç—ã</h2>
                    <div style="display: flex; flex-direction: column; gap: ${blockSpacing}px;">
                        ${portfolioItems.map(item => {
                            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                            let imageSrc = '';
                            if (item.content_type === 'image' && item.image) {
                                imageSrc = item.image;
                            } else if (item.content_type === 'gallery' && item.content_data?.images?.length > 0) {
                                imageSrc = item.content_data.images[0];
                            }
                            
                            // –¢–µ–∫—Å—Ç–æ–≤–∞—è —á–∞—Å—Ç—å (—Å–ª–µ–≤–∞)
                            const textSection = `
                                <div style="flex: 1; padding-right: 24px;">
                                    <h3 style="font-weight: ${textFontWeight}; font-size: ${parseInt(textH2Size) * 1.1}px; font-family: '${textFontFamily}', sans-serif; margin-bottom: 12px; color: ${fixedPrimaryColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${item.title}</h3>
                                    ${item.description ? `<p style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; color: ${fixedCardTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px; margin-bottom: 16px; opacity: 0.9;">${item.description}</p>` : ''}
                                    ${item.content_type === 'link' && item.content_data?.url ? `
                                        <a href="${item.content_data.url}" target="_blank" style="display: inline-block; padding: 10px 20px; background: ${fixedAccentColor}; color: white; border-radius: 6px; text-decoration: none; font-size: ${parseInt(textBodySize) * 0.9}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-top: 8px;">üîó Live View</a>
                                    ` : ''}
                                    ${item.category ? `<span style="font-size: ${parseInt(textBodySize) * 0.875}px; padding: 6px 12px; background: ${fixedPrimaryColor}; color: white; border-radius: 6px; margin-top: 12px; display: inline-block; font-weight: ${textFontWeight}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px;">${item.category}</span>` : ''}
                                    ${item.tags && item.tags.length > 0 ? `<div style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px;">${item.tags.map(tag => `<span style="font-size: ${parseInt(textBodySize) * 0.8}px; padding: 4px 10px; background: ${fixedCardBg}; color: ${fixedAccentColor}; border-radius: 6px; border: 1px solid ${fixedAccentColor};">#${tag}</span>`).join('')}</div>` : ''}
                                </div>
                            `;
                            
                            // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Å–ø—Ä–∞–≤–∞)
                            const imageSection = imageSrc ? `
                                <div style="flex: 0 0 40%; min-width: 300px; display: flex; align-items: center; justify-content: center;">
                                    <img src="${imageSrc}" alt="${item.title}" style="width: 100%; height: 280px; object-fit: cover; object-position: center; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow}; display: block; vertical-align: middle;">
                                </div>
                            ` : item.content_type === 'video' && item.content_data?.url ? `
                                <div style="flex: 0 0 40%; min-width: 300px; height: 280px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; display: flex; align-items: center; justify-content: center; color: ${fixedAccentColor}; border: 2px dashed ${fixedAccentColor};">
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 8px;">‚ñ∂Ô∏è</div>
                                        <div style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif;">–í–∏–¥–µ–æ</div>
                                    </div>
                                </div>
                            ` : item.content_type === 'link' && item.content_data?.url ? `
                                <div style="flex: 0 0 40%; min-width: 300px; height: 280px; background: ${fixedCardBg}; border-radius: ${fixedBorderRadius}; display: flex; align-items: center; justify-content: center; color: ${fixedAccentColor}; border: 2px solid ${fixedAccentColor};">
                                    <div style="text-align: center;">
                                        <div style="font-size: 48px; margin-bottom: 8px;">üîó</div>
                                        <div style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif;">–°—Å—ã–ª–∫–∞</div>
                                    </div>
                                </div>
                            ` : '';
                            
                            return `
                                <div style="display: flex; gap: 24px; background: ${isLightBg ? 'white' : '#4B5563'}; border-radius: ${fixedBorderRadius}; padding: 32px; box-shadow: ${fixedShadow}; align-items: center;">
                                    ${textSection}
                                    ${imageSection}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
            
            ${customBlocks && customBlocks.length > 0 ? customBlocks.map(block => {
                const blockTitle = block.title || '';
                const blockDescription = block.description || '';
                const blockImage = block.image || '';
                
                // Custom block specific settings (ONLY for custom blocks)
                const titleFontSize = block.titleFontSize || 24;
                const imageSizeRatio = block.imageSizeRatio || 55; // Image: 55% (matches reference)
                const textSizeRatio = 100 - imageSizeRatio; // Text: 45%
                const blockPadding = block.blockPadding || 12; // Compact padding
                
                // Block background color - use custom if set, otherwise use default
                const blockBgColor = block.backgroundColor || fixedCardBg;
                // Calculate text color based on background color
                const blockTextColor = window.PortfolioRenderer ? window.PortfolioRenderer.getOptimalTextColor(blockBgColor) : fixedCardTextColor;
                
                // FIXED LAYOUT: TEXT LEFT, IMAGE RIGHT (always, regardless of saved layout)
                // Compact horizontal card - NOT a large section
                
                // Image section - large relative to block, but block itself is compact
                // Image height is LIMITED to keep block compact (max 180px for compact card)
                const imageSection = blockImage ? `
                    <div class="custom-block-image-area" style="overflow: hidden; border-radius: ${fixedBorderRadius};">
                        <img src="${blockImage}" alt="${blockTitle}" style="width: 100%; height: auto; max-height: 180px; object-fit: cover; object-position: center; display: block;">
                    </div>
                ` : '';
                
                // Text section - left side, aligned to TOP (not center), compact
                const textSection = `
                    <div class="custom-block-text-area" style="display: flex; flex-direction: column; justify-content: flex-start; padding-right: 24px;">
                        ${blockTitle ? `<h2 class="custom-block-title" style="font-size: ${titleFontSize}px; font-family: '${textFontFamily}', sans-serif; font-weight: ${textFontWeight}; margin-bottom: 12px; color: ${fixedPrimaryColor}; line-height: 1.3; letter-spacing: ${textLetterSpacing}px; text-align: left; word-wrap: break-word; overflow-wrap: break-word;">${blockTitle}</h2>` : ''}
                        ${blockDescription ? `<div style="font-size: ${textBodySize}px; font-family: '${textFontFamily}', sans-serif; color: ${blockTextColor}; line-height: ${textLineHeight}; letter-spacing: ${textLetterSpacing}px; opacity: 0.9; word-wrap: break-word; overflow-wrap: break-word; text-align: left;">${blockDescription.replace(/\n/g, '<br>')}</div>` : ''}
                    </div>
                `;
                
                // CSS Grid: TEXT LEFT (45%), IMAGE RIGHT (55%)
                // Compact layout - NO min-height, height defined by content
                const contentLayout = blockImage ? `
                    <div class="custom-block-grid" style="display: grid; grid-template-columns: ${textSizeRatio}% ${imageSizeRatio}%; gap: 24px; align-items: start;">
                        ${textSection}
                        ${imageSection}
                    </div>
                ` : `
                    <div style="padding: 16px;">
                        ${textSection}
                    </div>
                `;
                
                return `
                    <div class="custom-block-container" style="margin-bottom: ${blockSpacing}px; width: 100%;">
                        <div style="background: ${blockBgColor}; border-radius: ${fixedBorderRadius}; box-shadow: ${fixedShadow}; padding: ${blockPadding}px; overflow: hidden;">
                            ${contentLayout}
                        </div>
                    </div>
                `;
            }).join('') : ''}
        </div>
    `;
    
        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —à—Ä–∏—Ñ—Ç
        if (textFontFamily !== 'Inter') {
            const link = document.createElement('link');
            link.href = `https://fonts.googleapis.com/css2?family=${textFontFamily.replace(' ', '+')}:wght@400;600;700&display=swap`;
            link.rel = 'stylesheet';
            if (!document.querySelector(`link[href*="${textFontFamily}"]`)) {
                document.head.appendChild(link);
            }
        }
    } catch (error) {
        console.error('Error updating preview:', error);
        const preview = document.getElementById('portfolio-preview');
        if (preview) {
            preview.innerHTML = `<div class="text-center py-20 text-red-500"><p>–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</p><p class="text-xs mt-2">${error.message || error}</p></div>`;
        }
    }
}

function addNewItem() {
    document.getElementById('item-modal-title').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É';
    document.getElementById('item-edit-id').value = '';
    document.getElementById('item-modal').classList.remove('hidden');
    document.getElementById('item-content-type').value = 'image';
    document.getElementById('item-title').value = '';
    document.getElementById('item-description').value = '';
    document.getElementById('item-category').value = '';
    document.getElementById('item-tags').value = '';
    document.getElementById('item-image').value = '';
    document.getElementById('item-image-preview').innerHTML = '';
    document.getElementById('item-video-url').value = '';
    document.getElementById('item-video-file').value = '';
    document.getElementById('item-video-preview').innerHTML = '';
    document.getElementById('item-link-url').value = '';
    document.getElementById('item-link-preview').classList.add('hidden');
    document.getElementById('item-gallery-images').value = '';
    document.getElementById('item-gallery-preview').innerHTML = '';
    document.getElementById('item-pdf-file').value = '';
    document.getElementById('item-pdf-preview').innerHTML = '';
    document.getElementById('item-text-content').value = '';
    changeContentType();
}

function editItem(index) {
    const item = portfolioItems[index];
    if (!item) return;
    
    document.getElementById('item-modal-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É';
    document.getElementById('item-edit-id').value = index;
    document.getElementById('item-modal').classList.remove('hidden');
    document.getElementById('item-content-type').value = item.content_type || 'image';
    document.getElementById('item-title').value = item.title || '';
    document.getElementById('item-description').value = item.description || '';
    document.getElementById('item-category').value = item.category || '';
    document.getElementById('item-tags').value = item.tags ? item.tags.join(', ') : '';
    document.getElementById('item-link-url').value = item.content_data?.url || '';
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const preview = document.getElementById('item-image-preview');
    if (item.image) {
        preview.innerHTML = `<img src="${item.image}" alt="Preview" class="max-w-full h-48 object-cover rounded-lg border border-gray-300">`;
    } else {
        preview.innerHTML = '';
    }
    
    changeContentType();
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if (item.content_type === 'image' && item.image) {
        document.getElementById('item-image-preview').innerHTML = `<img src="${item.image}" alt="Preview" style="max-width: 100%; max-height: 200px; border-radius: 8px;">`;
    } else if (item.content_type === 'video') {
        if (item.content_data?.url) {
            document.getElementById('item-video-url').value = item.content_data.url;
        }
    } else if (item.content_type === 'link') {
        if (item.content_data?.url) {
            document.getElementById('item-link-url').value = item.content_data.url;
            if (item.content_data.preview) {
                showLinkPreview(item.content_data.preview);
            }
        }
    } else if (item.content_type === 'gallery' && item.content_data?.images) {
        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–∞–ª–µ—Ä–µ–∏
    } else if (item.content_type === 'text' && item.content_data?.text) {
        document.getElementById('item-text-content').value = item.content_data.text;
    }
}

function closeItemModal() {
    document.getElementById('item-modal').classList.add('hidden');
}

async function saveItem() {
    const title = document.getElementById('item-title').value;
    const description = document.getElementById('item-description').value;
    const category = document.getElementById('item-category').value;
    const tagsStr = document.getElementById('item-tags').value;
    const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
    const contentType = document.getElementById('item-content-type').value;
    const editId = document.getElementById('item-edit-id').value;
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã');
        return;
    }
    
    const item = {
        title: title,
        description: description,
        category: category,
        tags: tags,
        content_type: contentType,
        content_data: {},
        image: null,
        imageFile: null
    };
    
    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if (contentType === 'image') {
        const imageInput = document.getElementById('item-image');
        if (imageInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                item.image = e.target.result;
                item.imageFile = imageInput.files[0];
                finishSaveItem(item, editId);
            };
            reader.readAsDataURL(imageInput.files[0]);
        } else {
            // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –∏ –Ω–µ –≤—ã–±—Ä–∞–ª–∏ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä–æ–µ
            if (editId !== '' && portfolioItems[editId]?.image) {
                item.image = portfolioItems[editId].image;
            }
            finishSaveItem(item, editId);
        }
    } else if (contentType === 'video') {
        const videoUrl = document.getElementById('item-video-url').value;
        const videoFile = document.getElementById('item-video-file').files[0];
        if (videoUrl) {
            item.content_data = { url: videoUrl };
            finishSaveItem(item, editId);
        } else if (videoFile) {
            item.content_data = { file: videoFile };
            item.videoFile = videoFile;
            finishSaveItem(item, editId);
        } else {
            if (editId !== '' && portfolioItems[editId]?.content_data) {
                item.content_data = portfolioItems[editId].content_data;
            }
            finishSaveItem(item, editId);
        }
    } else if (contentType === 'link') {
        const linkUrl = document.getElementById('item-link-url').value;
        if (linkUrl) {
            const preview = document.getElementById('item-link-preview');
            item.content_data = {
                url: linkUrl,
                title: document.getElementById('link-preview-title')?.textContent || '',
                description: document.getElementById('link-preview-description')?.textContent || '',
                preview: preview.classList.contains('hidden') ? null : {
                    image: document.getElementById('link-preview-image')?.src || '',
                    title: document.getElementById('link-preview-title')?.textContent || '',
                    description: document.getElementById('link-preview-description')?.textContent || ''
                }
            };
        }
        finishSaveItem(item, editId);
    } else if (contentType === 'gallery') {
        const galleryInput = document.getElementById('item-gallery-images');
        if (galleryInput.files.length > 0) {
            const images = [];
            const imageFiles = Array.from(galleryInput.files);
            let loaded = 0;
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    images.push({ src: e.target.result, file: file });
                    loaded++;
                    if (loaded === imageFiles.length) {
                        item.content_data = { images: images.map(img => img.src), imageFiles: imageFiles };
                        finishSaveItem(item, editId);
                    }
                };
                reader.readAsDataURL(file);
            });
        } else {
            if (editId !== '' && portfolioItems[editId]?.content_data) {
                item.content_data = portfolioItems[editId].content_data;
            }
            finishSaveItem(item, editId);
        }
    } else if (contentType === 'pdf') {
        const pdfFile = document.getElementById('item-pdf-file').files[0];
        if (pdfFile) {
            item.content_data = { file: pdfFile };
            item.pdfFile = pdfFile;
        } else {
            if (editId !== '' && portfolioItems[editId]?.content_data) {
                item.content_data = portfolioItems[editId].content_data;
            }
        }
        finishSaveItem(item, editId);
    } else if (contentType === 'text') {
        const textContent = document.getElementById('item-text-content').value;
        item.content_data = { text: textContent };
        finishSaveItem(item, editId);
    }
}

function finishSaveItem(item, editId) {
    if (editId !== '') {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        const oldItem = portfolioItems[editId];
        if (oldItem?.id) {
            item.id = oldItem.id;
        }
        portfolioItems[editId] = item;
    } else {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
        portfolioItems.push(item);
    }
    renderItems();
    updatePreview();
    closeItemModal();
}

async function fetchLinkPreview() {
    const url = document.getElementById('item-link-url').value;
    if (!url) {
        alert('–í–≤–µ–¥–∏—Ç–µ URL');
        return;
    }
    
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Open Graph API
    const preview = document.getElementById('item-link-preview');
    const titleEl = document.getElementById('link-preview-title');
    const descEl = document.getElementById('link-preview-description');
    const imgEl = document.getElementById('link-preview-image');
    
    preview.classList.remove('hidden');
    titleEl.textContent = new URL(url).hostname;
    descEl.textContent = url;
    imgEl.src = '';
    
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
    updatePreview();
}

function renderItems() {
    const container = document.getElementById('portfolio-items');
    if (!container) return;
    
    if (portfolioItems.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç</p>';
        return;
    }
    
    container.innerHTML = portfolioItems.map((item, index) => {
        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–≤—å—é
        let imageSrc = '';
        if (item.content_type === 'image' && item.image) {
            imageSrc = item.image;
        } else if (item.content_type === 'gallery' && item.content_data?.images?.length > 0) {
            imageSrc = item.content_data.images[0];
        }
        
        // –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const imagePreview = imageSrc ? 
            `<img src="${imageSrc}" alt="${escapeHtml(item.title)}" class="w-24 h-24 object-cover rounded-lg border border-gray-300">` :
            `<div class="w-24 h-24 bg-gray-200 rounded-lg border border-gray-300 flex items-center justify-center text-gray-400 text-xs">üì∑</div>`;
        
        return `
            <div class="portfolio-item bg-white p-3 rounded-lg border border-gray-200 hover:border-indigo-300 transition cursor-move" data-item-id="${item.id || ''}">
                <div class="flex gap-3 items-start">
                    <div class="flex-shrink-0">
                        ${imagePreview}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-sm text-gray-900 truncate">${escapeHtml(item.title)}</h3>
                                ${item.category ? `<span class="text-xs text-gray-500">${escapeHtml(item.category)}</span>` : ''}
                            </div>
                            <div class="flex gap-1 flex-shrink-0 ml-2">
                                <button onclick="editItem(${index})" class="px-1.5 py-1 text-blue-600 hover:text-blue-800 text-xs" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" type="button">‚úèÔ∏è</button>
                                <button onclick="removeItem(${index})" class="px-1.5 py-1 text-red-600 hover:text-red-800 text-xs" title="–£–¥–∞–ª–∏—Ç—å" type="button">√ó</button>
                            </div>
                        </div>
                        ${item.description ? `<p class="text-xs text-gray-600 mt-1 line-clamp-2">${escapeHtml(item.description)}</p>` : ''}
                        ${item.tags && item.tags.length > 0 ? `<div class="mt-1.5 flex flex-wrap gap-1">${item.tags.slice(0, 3).map(tag => `<span class="text-xs px-1.5 py-0.5 bg-gray-100 rounded">#${escapeHtml(tag)}</span>`).join('')}${item.tags.length > 3 ? `<span class="text-xs text-gray-400">+${item.tags.length - 3}</span>` : ''}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å sortable –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    initSortable();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function removeItem(index) {
    const item = portfolioItems[index];
    if (item.id) {
        // –£–¥–∞–ª–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
        try {
            const response = await fetch(`/api/portfolio/items/${item.id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            if (!response.ok) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã');
                return;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã');
            return;
        }
    }
    portfolioItems.splice(index, 1);
    renderItems();
    updatePreview();
}

// Save to LocalStorage library
async function saveToLibrary() {
    try {
        if (!window.portfolioService) {
            alert('–°–µ—Ä–≤–∏—Å –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }
        
        // Get portfolio title
        const name = document.getElementById('portfolio-name')?.value || '–ú–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ';
        const title = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ:', name);
        if (!title || !title.trim()) {
            return; // User cancelled
        }
        
        // CRITICAL: Serialize FULL editor state before saving
        let portfolioData;
        try {
            portfolioData = window.portfolioService.serializeEditorState();
            
            // Validate critical data is present
            if (!portfolioData.editorState) {
                throw new Error('Editor state is missing');
            }
            
        } catch (error) {
            console.error('Error serializing portfolio:', error);
            showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, true);
            return;
        }
        
        portfolioData.title = title.trim();
        
        // Get current portfolio ID from URL or create new
        const urlParams = new URLSearchParams(window.location.search);
        const portfolioId = urlParams.get('portfolio') || window.portfolioService.currentPortfolioId;
        if (portfolioId) {
            portfolioData.id = portfolioId;
        }
        
        // CRITICAL: Save to library and verify success
        let saved;
        try {
            saved = window.portfolioService.savePortfolio(portfolioData);
            
            // Verify save was successful
            if (!saved || !saved.id) {
                throw new Error('Save returned invalid data');
            }
            
            // Verify data was actually saved
            const verifyPortfolio = window.portfolioService.getPortfolio(saved.id);
            if (!verifyPortfolio) {
                throw new Error('Portfolio was not found after save');
            }
            
        } catch (error) {
            console.error('Error saving portfolio:', error);
            showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message, true);
            return;
        }
        
        // Show success message ONLY after verified save
        showSaveToast('–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É!', false);
        
        // Update URL if new portfolio
        if (!portfolioId && saved.id) {
            const newUrl = window.location.pathname + '?portfolio=' + saved.id;
            window.history.replaceState({}, '', newUrl);
        }
        
        window.portfolioService.currentPortfolioId = saved.id;
        window.portfolioService.unsavedChanges = false;
        
    } catch (error) {
        console.error('Error saving to library:', error);
        showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message, true);
    }
}

function showSaveToast(message, isError) {
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        background: ${isError ? '#ef4444' : '#10b981'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load portfolio from library on page load
// NOTE: This function is now called directly in DOMContentLoaded BEFORE rendering
// Keeping for backward compatibility but should not be called separately
function loadPortfolioFromLibrary() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const portfolioId = urlParams.get('portfolio');
        
        if (!portfolioId || !window.portfolioService) {
            return; // No portfolio to load
        }
        
        const portfolio = window.portfolioService.getPortfolio(portfolioId);
        if (!portfolio) {
            console.warn('Portfolio not found:', portfolioId);
            return;
        }
        
        // Load portfolio into editor
        window.portfolioService.loadPortfolioIntoEditor(portfolio);
        window.portfolioService.currentPortfolioId = portfolioId;
        
        // Show notification
        showSaveToast('–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏', false);
        
    } catch (error) {
        console.error('Error loading portfolio:', error);
        showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ: ' + error.message, true);
    }
}

// Export functions
async function exportPortfolioHTML() {
    try {
        // Validate export readiness
        const validation = window.portfolioExportService.validateExportReadiness();
        if (!validation.valid) {
            showSaveToast('–û—à–∏–±–∫–∞: ' + validation.error, true);
            return;
        }
        
        if (validation.warnings) {
            console.warn('Export warnings:', validation.warnings);
        }
        
        // Ensure preview is up to date
        updatePreview();
        
        // Wait a bit for preview to render
        await new Promise(resolve => setTimeout(resolve, 200));
        
        const portfolioId = window.portfolioService.currentPortfolioId;
        if (!portfolioId) {
            // Save first to get ID
            const portfolioData = window.portfolioService.serializeEditorState();
            portfolioData.title = document.getElementById('portfolio-name')?.value || '–ú–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ';
            const saved = window.portfolioService.savePortfolio(portfolioData);
            await window.portfolioExportService.exportAsHTML(saved.id);
        } else {
            await window.portfolioExportService.exportAsHTML(portfolioId);
        }
        showSaveToast('–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ HTML', false);
    } catch (error) {
        console.error('Export error:', error);
        showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ HTML: ' + error.message, true);
    }
}

async function exportPortfolioPDF() {
    try {
        // Validate export readiness
        const validation = window.portfolioExportService.validateExportReadiness();
        if (!validation.valid) {
            showSaveToast('–û—à–∏–±–∫–∞: ' + validation.error, true);
            return;
        }
        
        if (validation.warnings) {
            console.warn('Export warnings:', validation.warnings);
        }
        
        // Show loading indicator
        showSaveToast('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ PDF...', false);
        
        // Ensure preview is up to date
        updatePreview();
        
        // Wait for preview to render and stabilize
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const portfolioId = window.portfolioService.currentPortfolioId;
        if (!portfolioId) {
            // Save first to get ID
            const portfolioData = window.portfolioService.serializeEditorState();
            portfolioData.title = document.getElementById('portfolio-name')?.value || '–ú–æ–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ';
            const saved = window.portfolioService.savePortfolio(portfolioData);
            await window.portfolioExportService.exportAsPDF(saved.id);
        } else {
            await window.portfolioExportService.exportAsPDF(portfolioId);
        }
        showSaveToast('–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–∞–∫ PDF', false);
    } catch (error) {
        console.error('Export error:', error);
        showSaveToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ PDF: ' + error.message, true);
    }
}

function viewPortfolio() {
    const portfolioId = window.portfolioService.currentPortfolioId;
    if (!portfolioId) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É');
        return;
    }
    window.open(`/view/${portfolioId}/`, '_blank');
}

// Undo/Redo functions
function undoAction() {
    if (window.portfolioService && window.portfolioService.undo()) {
        showSaveToast('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', false);
    }
}

function redoAction() {
    if (window.portfolioService && window.portfolioService.redo()) {
        showSaveToast('–î–µ–π—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–æ', false);
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+Z for undo
    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undoAction();
    }
    // Ctrl+Y or Ctrl+Shift+Z for redo
    if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
        e.preventDefault();
        redoAction();
    }
    // Ctrl+S for save
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveToLibrary();
    }
});

// Warn about unsaved changes
window.addEventListener('beforeunload', function(e) {
    if (window.portfolioService && window.portfolioService.hasUnsavedChanges()) {
        e.preventDefault();
        e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
        return e.returnValue;
    }
});

// ==================== Color Picker Functions ====================
function initColorPickers() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ (–µ—Å–ª–∏ –æ–Ω–∏ –≤–∫–ª—é—á–µ–Ω—ã)
    const colorFields = ['primary', 'accent', 'background'];
    colorFields.forEach(color => {
        const colorInput = document.getElementById(`color-${color}`);
        const textInput = document.getElementById(`color-${color}-text`);
        
        if (colorInput && textInput) {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ customColors
            if (customColors[color]) {
                colorInput.value = customColors[color];
                textInput.value = customColors[color];
            }
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Ç–æ—Ä–æ–≥–æ —Ü–≤–µ—Ç–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞
    const bg2Input = document.getElementById('color-background-2');
    const bg2TextInput = document.getElementById('color-background-2-text');
    if (bg2Input && bg2TextInput) {
        bg2Input.value = '#f3f4f6';
        bg2TextInput.value = '#f3f4f6';
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–µ—Å–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    applyColorPreset('blue-professional');
}

// ==================== Social Links Functions ====================
function addSocialLink() {
    const container = document.getElementById('social-links-container');
    const div = document.createElement('div');
    div.className = 'flex gap-1.5 social-link-item';
    div.style.cssText = 'min-width: 0; width: 100%; max-width: 100%; box-sizing: border-box;';
    div.innerHTML = `
        <select class="px-2 py-1.5 text-xs border border-gray-300 rounded-md flex-shrink-0 social-platform" style="max-width: 120px; min-width: 80px; box-sizing: border-box;">
            <option value="vk">VK</option>
            <option value="instagram">Instagram</option>
            <option value="facebook">Facebook</option>
            <option value="linkedin">LinkedIn</option>
            <option value="github">GitHub</option>
            <option value="twitter">Twitter/X</option>
            <option value="telegram">Telegram</option>
            <option value="youtube">YouTube</option>
        </select>
        <input type="url" placeholder="https://..." class="flex-1 px-2 py-1.5 text-xs border border-gray-300 rounded-md social-url" style="min-width: 0; max-width: 100%; box-sizing: border-box; overflow: hidden;">
        <button onclick="removeSocialLink(this)" class="px-1.5 py-1.5 text-red-600 hover:text-red-800 text-sm flex-shrink-0" type="button">√ó</button>
    `;
    container.appendChild(div);
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
    const urlInput = div.querySelector('.social-url');
    const platformSelect = div.querySelector('.social-platform');
    if (urlInput) {
        urlInput.addEventListener('input', updatePreview);
        urlInput.setAttribute('data-listener-added', 'true');
    }
    if (platformSelect) {
        platformSelect.addEventListener('change', updatePreview);
        platformSelect.setAttribute('data-listener-added', 'true');
    }
    updatePreview();
}

function removeSocialLink(button) {
    button.closest('.social-link-item').remove();
    updatePreview();
}

// ==================== Skills Functions ====================
function addSkill() {
    const container = document.getElementById('skills-container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 skill-item';
    div.innerHTML = `
        <input type="text" placeholder="–ù–∞–≤—ã–∫" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg skill-input">
        <button onclick="removeSkill(this)" class="px-3 py-2 text-red-600 hover:text-red-800">√ó</button>
    `;
    container.appendChild(div);
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è
    const input = div.querySelector('.skill-input');
    if (input) {
        input.addEventListener('input', updatePreview);
        input.setAttribute('data-listener-added', 'true');
    }
    updatePreview();
}

function removeSkill(button) {
    button.parentElement.remove();
    updatePreview();
}

// ==================== Experience Functions ====================
function addExperience() {
    const container = document.getElementById('experience-container');
    const div = document.createElement('div');
    div.className = 'bg-gray-50 p-3 rounded-lg experience-item';
    div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            <span class="font-semibold text-sm">–ù–æ–≤—ã–π –æ–ø—ã—Ç</span>
            <button onclick="removeExperience(this)" class="text-red-600 hover:text-red-800 text-sm">√ó</button>
        </div>
        <input type="text" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded exp-position text-sm">
        <input type="text" placeholder="–ö–æ–º–ø–∞–Ω–∏—è" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded exp-company text-sm">
        <input type="text" placeholder="–ü–µ—Ä–∏–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2020-2023)" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded exp-period text-sm">
        <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded exp-description text-sm"></textarea>
    `;
    container.appendChild(div);
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
    div.querySelectorAll('input, textarea').forEach(input => {
        if (!input.hasAttribute('data-listener-added')) {
            input.addEventListener('input', updatePreview);
            input.setAttribute('data-listener-added', 'true');
        }
    });
    updatePreview();
}

function removeExperience(button) {
    button.closest('.experience-item').remove();
    updatePreview();
}

// ==================== Education Functions ====================
function addEducation() {
    const container = document.getElementById('education-container');
    const div = document.createElement('div');
    div.className = 'bg-gray-50 p-3 rounded-lg education-item';
    div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            <span class="font-semibold text-sm">–ù–æ–≤–æ–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</span>
            <button onclick="removeEducation(this)" class="text-red-600 hover:text-red-800 text-sm">√ó</button>
        </div>
        <input type="text" placeholder="–£—á—Ä–µ–∂–¥–µ–Ω–∏–µ" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded edu-institution text-sm">
        <input type="text" placeholder="–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded edu-specialty text-sm">
        <input type="text" placeholder="–ü–µ—Ä–∏–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2016-2020)" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded edu-period text-sm">
        <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" rows="2" class="w-full px-3 py-1 border border-gray-300 rounded edu-description text-sm"></textarea>
    `;
    container.appendChild(div);
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
    div.querySelectorAll('input, textarea').forEach(input => {
        if (!input.hasAttribute('data-listener-added')) {
            input.addEventListener('input', updatePreview);
            input.setAttribute('data-listener-added', 'true');
        }
    });
    updatePreview();
}

function removeEducation(button) {
    button.closest('.education-item').remove();
    updatePreview();
}

// ==================== Certificates Functions ====================
function addCertificate() {
    const container = document.getElementById('certificates-container');
    const div = document.createElement('div');
    div.className = 'bg-gray-50 p-3 rounded-lg certificate-item';
    div.innerHTML = `
        <div class="flex justify-between items-start mb-2">
            <span class="font-semibold text-sm">–ù–æ–≤—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</span>
            <button onclick="removeCertificate(this)" class="text-red-600 hover:text-red-800 text-sm">√ó</button>
        </div>
        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded cert-name text-sm">
        <input type="text" placeholder="–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded cert-organization text-sm">
        <input type="date" placeholder="–î–∞—Ç–∞" class="w-full px-3 py-1 mb-2 border border-gray-300 rounded cert-date text-sm">
        <input type="url" placeholder="–°—Å—ã–ª–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="w-full px-3 py-1 border border-gray-300 rounded cert-link text-sm">
    `;
    container.appendChild(div);
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
    div.querySelectorAll('input').forEach(input => {
        if (!input.hasAttribute('data-listener-added')) {
            input.addEventListener('input', updatePreview);
            input.addEventListener('change', updatePreview);
            input.setAttribute('data-listener-added', 'true');
        }
    });
    updatePreview();
}

function removeCertificate(button) {
    button.closest('.certificate-item').remove();
    updatePreview();
}

// ==================== Languages Functions ====================
function addLanguage() {
    const container = document.getElementById('languages-container');
    const div = document.createElement('div');
    div.className = 'flex gap-2 language-item';
    div.innerHTML = `
        <input type="text" placeholder="–Ø–∑—ã–∫" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg lang-language">
        <select class="px-3 py-2 border border-gray-300 rounded-lg lang-level">
            <option value="beginner">–ù–∞—á–∞–ª—å–Ω—ã–π</option>
            <option value="intermediate">–°—Ä–µ–¥–Ω–∏–π</option>
            <option value="advanced">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π</option>
            <option value="native">–†–æ–¥–Ω–æ–π</option>
        </select>
        <button onclick="removeLanguage(this)" class="px-3 py-2 text-red-600 hover:text-red-800">√ó</button>
    `;
    container.appendChild(div);
    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
    const languageInput = div.querySelector('.lang-language');
    const levelSelect = div.querySelector('.lang-level');
    if (languageInput) {
        languageInput.addEventListener('input', updatePreview);
        languageInput.setAttribute('data-listener-added', 'true');
    }
    if (levelSelect) {
        levelSelect.addEventListener('change', updatePreview);
        levelSelect.setAttribute('data-listener-added', 'true');
    }
    updatePreview();
}

function removeLanguage(button) {
    button.parentElement.remove();
    updatePreview();
}

// ==================== Helper Functions ====================
function hexToRgb(hex) {
    if (!hex || typeof hex !== 'string') {
        return { r: 79, g: 70, b: 229 }; // Fallback color
    }
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : { r: 79, g: 70, b: 229 };
}

/**
 * Calculate relative luminance of a color (WCAG 2.1)
 * @param {string} hex - Hex color code
 * @returns {number} Luminance value between 0 and 1
 */
function getLuminance(hex) {
    try {
        const rgb = hexToRgb(hex);
        // Normalize RGB values to 0-1 range
        const r = rgb.r / 255;
        const g = rgb.g / 255;
        const b = rgb.b / 255;
        
        // Apply gamma correction
        const rLinear = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
        const gLinear = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
        const bLinear = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);
        
        // Calculate relative luminance
        return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear;
    } catch (error) {
        console.error('Error calculating luminance:', error);
        return 0.5; // Fallback to medium luminance
    }
}

/**
 * Get optimal text color (black or white) based on background color
 * @param {string} bgColor - Background color in hex format
 * @returns {string} '#000000' for light backgrounds, '#FFFFFF' for dark backgrounds
 */
function getOptimalTextColor(bgColor) {
    try {
        if (!bgColor || typeof bgColor !== 'string') {
            return '#000000'; // Fallback to black
        }
        
        const luminance = getLuminance(bgColor);
        // If background is light (luminance > 0.5), use dark text, otherwise use light text
        return luminance > 0.5 ? '#000000' : '#FFFFFF';
    } catch (error) {
        console.error('Error getting optimal text color:', error);
        return '#000000'; // Fallback to black
    }
}

/**
 * Calculate contrast ratio between two colors (WCAG 2.1)
 * @param {string} color1 - First color in hex format
 * @param {string} color2 - Second color in hex format
 * @returns {number} Contrast ratio (1.0 to 21.0)
 */
function getContrastRatio(color1, color2) {
    try {
        const lum1 = getLuminance(color1);
        const lum2 = getLuminance(color2);
        
        const lighter = Math.max(lum1, lum2);
        const darker = Math.min(lum1, lum2);
        
        return (lighter + 0.05) / (darker + 0.05);
    } catch (error) {
        console.error('Error calculating contrast ratio:', error);
        return 1.0; // Fallback to minimum contrast
    }
}

/**
 * Validate color contrast according to WCAG 2.1 standards
 * @returns {Object} Validation result with isValid flag and messages
 */
function validateColorContrast() {
    try {
        const primaryColor = document.getElementById('color-primary')?.value || customColors.primary || '#2563EB';
        const accentColor = document.getElementById('color-accent')?.value || customColors.accent || '#1E40AF';
        const bgColor = document.getElementById('color-background')?.value || customColors.background || '#ffffff';
        
        const issues = [];
        let isValid = true;
        
        // Check normal text contrast (‚â• 4.5:1)
        const primaryContrast = getContrastRatio(primaryColor, bgColor);
        const accentContrast = getContrastRatio(accentColor, bgColor);
        
        if (primaryContrast < 4.5) {
            issues.push(`Primary color contrast (${primaryContrast.toFixed(2)}:1) is below WCAG AA standard (4.5:1) for normal text`);
            isValid = false;
        }
        
        if (accentContrast < 4.5) {
            issues.push(`Accent color contrast (${accentContrast.toFixed(2)}:1) is below WCAG AA standard (4.5:1) for normal text`);
            isValid = false;
        }
        
        // Check UI elements contrast (‚â• 3:1)
        if (primaryContrast < 3.0) {
            issues.push(`Primary color contrast (${primaryContrast.toFixed(2)}:1) is below WCAG AA standard (3:1) for UI elements`);
            isValid = false;
        }
        
        if (accentContrast < 3.0) {
            issues.push(`Accent color contrast (${accentContrast.toFixed(2)}:1) is below WCAG AA standard (3:1) for UI elements`);
            isValid = false;
        }
        
        return {
            isValid: isValid,
            issues: issues,
            primaryContrast: primaryContrast,
            accentContrast: accentContrast
        };
    } catch (error) {
        console.error('Error validating color contrast:', error);
        return {
            isValid: true, // Don't block on validation errors
            issues: [],
            primaryContrast: 4.5,
            accentContrast: 4.5
        };
    }
}

/**
 * Apply a predefined color preset
 * @param {string} presetName - Name of the preset ('blue-professional', 'purple-creative', 'dark-minimal', 'green-tech')
 */
function applyColorPreset(presetName) {
    try {
        const presets = {
            'blue-professional': {
                primary: '#2563EB',
                accent: '#1E40AF',
                background: '#ffffff',
                background2: '#f3f4f6'
            },
            'purple-creative': {
                primary: '#7C3AED',
                accent: '#5B21B6',
                background: '#ffffff',
                background2: '#f3f4f6'
            },
            'dark-minimal': {
                primary: '#E5E7EB',
                accent: '#60A5FA',
                background: '#1F2937',
                background2: '#111827'
            },
            'green-tech': {
                primary: '#16A34A',
                accent: '#15803D',
                background: '#ffffff',
                background2: '#f3f4f6'
            }
        };
        
        let preset = presets[presetName];
        if (!preset) {
            console.warn(`Preset "${presetName}" not found. Using default.`);
            preset = presets['blue-professional'];
        }
        
        // Update customColors object
        customColors.primary = preset.primary;
        customColors.accent = preset.accent;
        customColors.background = preset.background;
        customColors.background2 = preset.background2;
        
        // Update color picker inputs
        const primaryInput = document.getElementById('color-primary');
        const accentInput = document.getElementById('color-accent');
        const backgroundInput = document.getElementById('color-background');
        const background2Input = document.getElementById('color-background-2');
        
        if (primaryInput) {
            primaryInput.value = preset.primary;
            const primaryTextInput = document.getElementById('color-primary-text');
            if (primaryTextInput) primaryTextInput.value = preset.primary;
        }
        
        if (accentInput) {
            accentInput.value = preset.accent;
            const accentTextInput = document.getElementById('color-accent-text');
            if (accentTextInput) accentTextInput.value = preset.accent;
        }
        
        if (backgroundInput) {
            backgroundInput.value = preset.background;
            const backgroundTextInput = document.getElementById('color-background-text');
            if (backgroundTextInput) backgroundTextInput.value = preset.background;
            // Update background preview
            const preview = document.getElementById('background-preview');
            if (preview) {
                const bgType = document.getElementById('background-type')?.value || 'solid';
                if (bgType === 'gradient') {
                    preview.style.background = `linear-gradient(135deg, ${preset.background} 0%, ${preset.background2} 100%)`;
                } else {
                    preview.style.background = preset.background;
                }
            }
        }
        
        if (background2Input) {
            background2Input.value = preset.background2;
            const background2TextInput = document.getElementById('color-background-2-text');
            if (background2TextInput) background2TextInput.value = preset.background2;
            // Update gradient preview
            const gradientPreview = document.getElementById('gradient-preview');
            if (gradientPreview) {
                const bg1 = document.getElementById('color-background')?.value || preset.background;
                gradientPreview.style.background = `linear-gradient(135deg, ${bg1} 0%, ${preset.background2} 100%)`;
            }
        }
        
        // Update card background (auto-detect based on preset background)
        const cardBgInput = document.getElementById('color-card-background');
        if (cardBgInput) {
            const isLightBg = getLuminance(preset.background) > 0.5;
            const cardBg = isLightBg ? '#f9fafb' : '#374151';
            cardBgInput.value = cardBg;
            const cardBgTextInput = document.getElementById('color-card-background-text');
            if (cardBgTextInput) cardBgTextInput.value = cardBg;
            // Update card background preview
            const cardPreview = document.getElementById('card-background-preview');
            if (cardPreview) {
                cardPreview.style.background = cardBg;
            }
            customColors.cardBackground = cardBg;
        }
        
        // Hide custom colors section
        const customColorsSection = document.getElementById('custom-colors-section');
        if (customColorsSection) {
            customColorsSection.classList.add('hidden');
        }
        
        // Update active preset button
        document.querySelectorAll('.color-preset-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-indigo-100');
        });
        const activeBtn = document.querySelector(`.color-preset-btn[data-preset="${presetName}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active', 'bg-indigo-100');
        }
        
        // Update preview
        updatePreview();
        markChanged();
    } catch (error) {
        console.error('Error applying color preset:', error);
    }
}

/**
 * Enable custom color input mode
 */
function enableCustomColors() {
    try {
        const customColorsSection = document.getElementById('custom-colors-section');
        if (customColorsSection) {
            customColorsSection.classList.remove('hidden');
        }
        
        // Remove active state from preset buttons
        document.querySelectorAll('.color-preset-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-indigo-100');
        });
        
        // Validate contrast when custom colors are enabled
        validateColorContrast();
    } catch (error) {
        console.error('Error enabling custom colors:', error);
    }
}

function setTextAlign(align) {
    document.querySelectorAll('.text-align-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-100'));
    const btn = document.querySelector(`.text-align-btn[data-align="${align}"]`);
    if (btn) {
        btn.classList.add('active', 'bg-indigo-100');
    }
    updatePreview();
}

function setGridColumns(cols) {
    document.querySelectorAll('.grid-cols-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-100'));
    const btn = document.querySelector(`.grid-cols-btn[data-cols="${cols}"]`);
    if (btn) {
        btn.classList.add('active', 'bg-indigo-100');
    }
    updatePreview();
}

function setSpacingPreset(preset) {
    document.querySelectorAll('.spacing-preset-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-100'));
    const btn = document.querySelector(`.spacing-preset-btn[data-preset="${preset}"]`);
    if (btn) {
        btn.classList.add('active', 'bg-indigo-100');
    }
    
    // Update the slider value
    const spacingMap = {
        'compact': 12,
        'normal': 24,
        'spacious': 40
    };
    const spacingValue = spacingMap[preset] || 24;
    const spacingSlider = document.getElementById('block-spacing');
    const spacingDisplay = document.getElementById('block-spacing-value');
    if (spacingSlider) {
        spacingSlider.value = spacingValue;
        if (spacingDisplay) spacingDisplay.textContent = spacingValue + 'px';
    }
    updatePreview();
}

function setCardStyle(style) {
    document.querySelectorAll('.card-style-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-100'));
    const btn = document.querySelector(`.card-style-btn[data-style="${style}"]`);
    if (btn) {
        btn.classList.add('active', 'bg-indigo-100');
    }
    updatePreview();
}

function setBorderRadius(radius) {
    document.querySelectorAll('.border-radius-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-100'));
    const btn = document.querySelector(`.border-radius-btn[data-radius="${radius}"]`);
    if (btn) {
        btn.classList.add('active', 'bg-indigo-100');
    }
    updatePreview();
}

// –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ
window.setTextAlign = setTextAlign;
window.setGridColumns = setGridColumns;
window.setSpacingPreset = setSpacingPreset;
window.setCardStyle = setCardStyle;
window.setBorderRadius = setBorderRadius;
window.addSkill = addSkill;
window.removeSkill = removeSkill;
window.addSocialLink = addSocialLink;
window.removeSocialLink = removeSocialLink;
window.addExperience = addExperience;
window.removeExperience = removeExperience;
window.addEducation = addEducation;
window.removeEducation = removeEducation;
window.addCertificate = addCertificate;
window.removeCertificate = removeCertificate;
window.addLanguage = addLanguage;
window.removeLanguage = removeLanguage;
window.applyColorPreset = applyColorPreset;
window.enableCustomColors = enableCustomColors;
window.resetColors = resetColors;
window.saveToLibrary = saveToLibrary;
window.exportPortfolioHTML = exportPortfolioHTML;
window.exportPortfolioPDF = exportPortfolioPDF;
window.viewPortfolio = viewPortfolio;
window.undoAction = undoAction;
window.redoAction = redoAction;
window.getOptimalTextColor = getOptimalTextColor;
window.getLuminance = getLuminance;
window.getContrastRatio = getContrastRatio;
window.validateColorContrast = validateColorContrast;

function resetColors() {
    applyColorPreset('blue-professional');
}

// ==================== Design Settings Functions ====================
function initDesignSettings() {
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    if (designSettings.font_family) {
        document.getElementById('design-font-family').value = designSettings.font_family;
    }
    if (designSettings.font_size) {
        if (designSettings.font_size.h1) {
            document.getElementById('design-h1-size').value = designSettings.font_size.h1;
            document.getElementById('design-h1-size-value').textContent = designSettings.font_size.h1 + 'px';
        }
        if (designSettings.font_size.body) {
            document.getElementById('design-body-size').value = designSettings.font_size.body;
            document.getElementById('design-body-size-value').textContent = designSettings.font_size.body + 'px';
        }
    }
    if (designSettings.padding) {
        document.getElementById('design-padding').value = designSettings.padding;
        document.getElementById('design-padding-value').textContent = designSettings.padding + 'px';
    }
    if (designSettings.border_radius) {
        document.getElementById('design-border-radius').value = designSettings.border_radius;
        document.getElementById('design-border-radius-value').textContent = designSettings.border_radius + 'px';
    }
    if (designSettings.box_shadow) {
        document.getElementById('design-box-shadow').value = designSettings.box_shadow;
    }
}

// ==================== Content Type Functions ====================
function changeContentType() {
    const contentType = document.getElementById('item-content-type').value;
    document.querySelectorAll('.content-form').forEach(form => form.classList.add('hidden'));
    document.getElementById(`content-form-${contentType}`).classList.remove('hidden');
}

// ==================== Item Management Functions ====================
function initSortable() {
    const container = document.getElementById('portfolio-items');
    if (!container) return;
    
    // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π Sortable, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (container.sortableInstance) {
        container.sortableInstance.destroy();
    }
    
    if (typeof Sortable !== 'undefined') {
        container.sortableInstance = new Sortable(container, {
            animation: 150,
            handle: '.portfolio-item',
            ghostClass: 'opacity-50',
            chosenClass: 'bg-blue-50',
            onEnd: function(evt) {
                // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –≤ –º–∞—Å—Å–∏–≤–µ portfolioItems
                const oldIndex = evt.oldIndex;
                const newIndex = evt.newIndex;
                if (oldIndex !== newIndex) {
                    const movedItem = portfolioItems.splice(oldIndex, 1)[0];
                    portfolioItems.splice(newIndex, 0, movedItem);
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    const itemIds = portfolioItems.map(item => item.id).filter(id => id);
                    if (itemIds.length > 0) {
                        reorderItems(itemIds);
                    }
                    
                    updatePreview();
                }
            }
        });
    }
}

async function reorderItems(itemIds) {
    try {
        const portfolioId = {% if portfolio.id %}{{ portfolio.id }}{% else %}null{% endif %};
        if (!portfolioId) {
            console.warn('Portfolio ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ—Ä—è–¥–æ–∫ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            return;
        }
        
        const response = await fetch('/api/portfolio/items/reorder/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                portfolio: portfolioId,
                item_ids: itemIds
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞ —Ä–∞–±–æ—Ç:', errorData);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==================== Custom Blocks Functions ====================

/**
 * Open modal to add a new custom block
 */
function addCustomBlock() {
    const modal = document.getElementById('custom-block-modal');
    const title = document.getElementById('custom-block-modal-title');
    const editId = document.getElementById('custom-block-edit-id');
    
    // Reset form
    document.getElementById('custom-block-name').value = '';
    document.getElementById('custom-block-title').value = '';
    document.getElementById('custom-block-description').value = '';
    document.getElementById('custom-block-image').value = '';
    document.getElementById('custom-block-image-preview').innerHTML = '';
    document.getElementById('custom-block-layout').value = 'image-right';
    editId.value = '';
    
    // Reset alignment buttons (left is default for custom blocks)
    document.querySelectorAll('.custom-block-align-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    document.querySelector('.custom-block-align-btn[data-align="left"]').classList.add('active', 'bg-indigo-100');
    
    // Reset size buttons
    document.querySelectorAll('.custom-block-size-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    document.querySelector('.custom-block-size-btn[data-size="full"]').classList.add('active', 'bg-indigo-100');
    
    // Reset title size
    document.getElementById('custom-block-title-size').value = 24;
    updateCustomBlockTitleSizeValue(24);
    document.querySelectorAll('.custom-block-title-size-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    document.querySelector('.custom-block-title-size-btn[data-size="medium"]').classList.add('active', 'bg-indigo-100');
    
    // Reset image ratio (55% for reference design: 45% text / 55% image)
    document.getElementById('custom-block-image-ratio').value = 55;
    updateCustomBlockImageRatioValue(55);
    
    // Reset block padding (compact: 12px)
    document.getElementById('custom-block-padding').value = 12;
    updateCustomBlockPaddingValue(12);
    
    // Reset background color
    resetCustomBlockBgColor();
    
    // Set title
    if (title) title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –±–ª–æ–∫';
    
    // Show modal
    if (modal) modal.classList.remove('hidden');
}

/**
 * Close custom block modal
 */
function closeCustomBlockModal() {
    const modal = document.getElementById('custom-block-modal');
    if (modal) modal.classList.add('hidden');
}

/**
 * Set text alignment for custom block
 */
function setCustomBlockAlign(align) {
    document.querySelectorAll('.custom-block-align-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    const btn = document.querySelector(`.custom-block-align-btn[data-align="${align}"]`);
    if (btn) btn.classList.add('active', 'bg-indigo-100');
}

/**
 * Set block size
 */
function setCustomBlockSize(size) {
    document.querySelectorAll('.custom-block-size-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    const btn = document.querySelector(`.custom-block-size-btn[data-size="${size}"]`);
    if (btn) btn.classList.add('active', 'bg-indigo-100');
}

/**
 * Set custom block title size (preset)
 */
function setCustomBlockTitleSize(size) {
    document.querySelectorAll('.custom-block-title-size-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    const btn = document.querySelector(`.custom-block-title-size-btn[data-size="${size}"]`);
    if (btn) btn.classList.add('active', 'bg-indigo-100');
    
    const sizeMap = {
        'small': 18,
        'medium': 24,
        'large': 32,
        'xlarge': 40
    };
    const value = sizeMap[size] || 24;
    const slider = document.getElementById('custom-block-title-size');
    if (slider) {
        slider.value = value;
        updateCustomBlockTitleSizeValue(value);
    }
}

/**
 * Update title size value display
 */
function updateCustomBlockTitleSizeValue(value) {
    const display = document.getElementById('custom-block-title-size-value');
    if (display) display.textContent = `(${value}px)`;
    // Update preview if editing
    const editId = document.getElementById('custom-block-edit-id')?.value;
    if (editId) {
        const block = window.customBlocks.find(b => b.id === editId);
        if (block) {
            block.titleFontSize = parseInt(value);
            updatePreview();
        }
    }
}

/**
 * Update image ratio value display
 */
function updateCustomBlockImageRatioValue(value) {
    const display = document.getElementById('custom-block-image-ratio-value');
    if (display) display.textContent = `(${value}%)`;
    // Update preview if editing
    const editId = document.getElementById('custom-block-edit-id')?.value;
    if (editId) {
        const block = window.customBlocks.find(b => b.id === editId);
        if (block) {
            block.imageSizeRatio = parseInt(value);
            updatePreview();
        }
    }
}

/**
 * Update block padding value display
 */
function updateCustomBlockPaddingValue(value) {
    const display = document.getElementById('custom-block-padding-value');
    if (display) display.textContent = `(${value}px)`;
    // Update preview if editing
    const editId = document.getElementById('custom-block-edit-id')?.value;
    if (editId) {
        const block = window.customBlocks.find(b => b.id === editId);
        if (block) {
            block.blockPadding = parseInt(value);
            updatePreview();
        }
    }
}

/**
 * Save custom block (add or update)
 */
function saveCustomBlock() {
    const name = document.getElementById('custom-block-name')?.value?.trim();
    const title = document.getElementById('custom-block-title')?.value?.trim();
    const description = document.getElementById('custom-block-description')?.value?.trim();
    const imageInput = document.getElementById('custom-block-image');
    // Fixed layout: always image-right (text left, image right) to match reference design
    const layout = 'image-right';
    const alignment = document.querySelector('.custom-block-align-btn.active')?.dataset.align || 'left';
    const size = document.querySelector('.custom-block-size-btn.active')?.dataset.size || 'full';
    const titleSize = parseInt(document.getElementById('custom-block-title-size')?.value) || 24;
    const imageRatio = parseInt(document.getElementById('custom-block-image-ratio')?.value) || 55;
    const blockPadding = parseInt(document.getElementById('custom-block-padding')?.value) || 16;
    const blockBgColor = document.getElementById('custom-block-bg-color')?.value || '';
    const editId = document.getElementById('custom-block-edit-id')?.value;
    
    // Validation
    if (!name || !title) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫');
        return;
    }
    
    // Get image (if uploaded)
    let imageSrc = '';
    if (imageInput?.files?.length > 0) {
        const file = imageInput.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            imageSrc = e.target.result;
            finishSaveBlock(name, title, description, imageSrc, layout, alignment, size, titleSize, imageRatio, blockPadding, blockBgColor, editId);
        };
        reader.readAsDataURL(file);
    } else {
        // Check if there's an existing image preview
        const preview = document.getElementById('custom-block-image-preview');
        const existingImg = preview?.querySelector('img');
        if (existingImg) {
            imageSrc = existingImg.src;
        }
        finishSaveBlock(name, title, description, imageSrc, layout, alignment, size, titleSize, imageRatio, blockPadding, blockBgColor, editId);
    }
}

/**
 * Finish saving custom block
 */
function finishSaveBlock(name, title, description, imageSrc, layout, alignment, size, titleSize, imageRatio, blockPadding, blockBgColor, editId) {
    // Ensure window.customBlocks exists
    if (!window.customBlocks) {
        window.customBlocks = [];
    }
    
    const block = {
        id: editId || 'block_' + Date.now(),
        name: name,
        title: title,
        description: description,
        image: imageSrc,
        layout: layout,
        alignment: alignment,
        size: size,
        titleFontSize: titleSize,
        imageSizeRatio: imageRatio,
        blockPadding: blockPadding,
        backgroundColor: blockBgColor || null
    };
    
    // Update or add block
    if (editId) {
        const index = window.customBlocks.findIndex(b => b.id === editId);
        if (index !== -1) {
            window.customBlocks[index] = block;
        } else {
            window.customBlocks.push(block);
        }
    } else {
        window.customBlocks.push(block);
    }
    
    // Update global array (sync with local variable)
    customBlocks = window.customBlocks;
    
    // Render blocks list
    renderCustomBlocks();
    
    // Update preview
    updatePreview();
    
    // Mark as changed
    if (window.portfolioService) {
        window.portfolioService.markUnsaved();
    }
    
    // Close modal
    closeCustomBlockModal();
}

/**
 * Render custom blocks list in editor
 */
function renderCustomBlocks() {
    const container = document.getElementById('custom-blocks-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!window.customBlocks || window.customBlocks.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-400 text-center py-2">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –±–ª–æ–∫–æ–≤</p>';
        return;
    }
    
    window.customBlocks.forEach((block, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded border border-gray-200';
        div.innerHTML = `
            <div class="flex-1 min-w-0">
                <p class="text-xs font-medium text-gray-900 truncate">${block.name || block.title || '–ë–ª–æ–∫ ' + (index + 1)}</p>
                <p class="text-xs text-gray-500 truncate">${block.title || ''}</p>
            </div>
            <div class="flex items-center gap-1 ml-2">
                <button onclick="editCustomBlock('${block.id}')" class="px-2 py-1 text-xs text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                    ‚úèÔ∏è
                </button>
                <button onclick="deleteCustomBlock('${block.id}')" class="px-2 py-1 text-xs text-red-600 hover:text-red-800 hover:bg-red-50 rounded" title="–£–¥–∞–ª–∏—Ç—å">
                    üóëÔ∏è
                </button>
            </div>
        `;
        container.appendChild(div);
    });
    
    // Initialize sortable for custom blocks
    if (typeof Sortable !== 'undefined') {
        new Sortable(container, {
            animation: 150,
            handle: '.flex-1',
            onEnd: function(evt) {
                // Reorder blocks
                const item = window.customBlocks.splice(evt.oldIndex, 1)[0];
                window.customBlocks.splice(evt.newIndex, 0, item);
                customBlocks = window.customBlocks;
                updatePreview();
                if (window.portfolioService) {
                    window.portfolioService.markUnsaved();
                }
            }
        });
    }
}

/**
 * Edit custom block
 */
function editCustomBlock(blockId) {
    const block = window.customBlocks.find(b => b.id === blockId);
    if (!block) return;
    
    const modal = document.getElementById('custom-block-modal');
    const title = document.getElementById('custom-block-modal-title');
    const editId = document.getElementById('custom-block-edit-id');
    
    // Fill form
    document.getElementById('custom-block-name').value = block.name || '';
    document.getElementById('custom-block-title').value = block.title || '';
    document.getElementById('custom-block-description').value = block.description || '';
    // Always use image-right layout (text left, image right) to match reference design
    document.getElementById('custom-block-layout').value = 'image-right';
    editId.value = block.id;
    
    // Set image preview
    const preview = document.getElementById('custom-block-image-preview');
    if (block.image && preview) {
        preview.innerHTML = `<img src="${block.image}" alt="Preview" class="max-w-full h-32 object-cover rounded border border-gray-300">`;
    } else if (preview) {
        preview.innerHTML = '';
    }
    
    // Set alignment (left is default for custom blocks)
    document.querySelectorAll('.custom-block-align-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    const alignBtn = document.querySelector(`.custom-block-align-btn[data-align="${block.alignment || 'left'}"]`);
    if (alignBtn) alignBtn.classList.add('active', 'bg-indigo-100');
    
    // Set size
    document.querySelectorAll('.custom-block-size-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    const sizeBtn = document.querySelector(`.custom-block-size-btn[data-size="${block.size || 'full'}"]`);
    if (sizeBtn) sizeBtn.classList.add('active', 'bg-indigo-100');
    
    // Set title size
    const titleSize = block.titleFontSize || 24;
    document.getElementById('custom-block-title-size').value = titleSize;
    updateCustomBlockTitleSizeValue(titleSize);
    document.querySelectorAll('.custom-block-title-size-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-100');
    });
    const titleSizePreset = titleSize <= 20 ? 'small' : titleSize <= 28 ? 'medium' : titleSize <= 36 ? 'large' : 'xlarge';
    const titleSizeBtn = document.querySelector(`.custom-block-title-size-btn[data-size="${titleSizePreset}"]`);
    if (titleSizeBtn) titleSizeBtn.classList.add('active', 'bg-indigo-100');
    
    // Set image ratio
    const imageRatio = block.imageSizeRatio || 55;
    document.getElementById('custom-block-image-ratio').value = imageRatio;
    updateCustomBlockImageRatioValue(imageRatio);
    
    // Set block padding
    const blockPadding = block.blockPadding || 12;
    document.getElementById('custom-block-padding').value = blockPadding;
    updateCustomBlockPaddingValue(blockPadding);
    
    // Set background color
    const bgColor = block.backgroundColor || '#f9fafb';
    document.getElementById('custom-block-bg-color').value = bgColor;
    document.getElementById('custom-block-bg-color-text').value = bgColor;
    updateCustomBlockBgColorPreview();
    
    // Set title
    if (title) title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –±–ª–æ–∫';
    
    // Show modal
    if (modal) modal.classList.remove('hidden');
}

/**
 * Update custom block background color preview
 */
function updateCustomBlockBgColorPreview() {
    const colorInput = document.getElementById('custom-block-bg-color');
    const preview = document.getElementById('custom-block-bg-color-preview');
    if (colorInput && preview) {
        preview.style.background = colorInput.value;
    }
}

/**
 * Update color picker from text input
 */
function updateCustomBlockBgColorFromText() {
    const textInput = document.getElementById('custom-block-bg-color-text');
    const colorInput = document.getElementById('custom-block-bg-color');
    if (textInput && colorInput) {
        const color = textInput.value.trim();
        if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
            colorInput.value = color;
            updateCustomBlockBgColorPreview();
        }
    }
}

/**
 * Reset custom block background color to default
 */
function resetCustomBlockBgColor() {
    const defaultColor = '#f9fafb';
    document.getElementById('custom-block-bg-color').value = defaultColor;
    document.getElementById('custom-block-bg-color-text').value = defaultColor;
    updateCustomBlockBgColorPreview();
    updatePreview();
}

/**
 * Delete custom block
 */
function deleteCustomBlock(blockId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) return;
    
    window.customBlocks = window.customBlocks.filter(b => b.id !== blockId);
    customBlocks = window.customBlocks;
    
    renderCustomBlocks();
    updatePreview();
    
    if (window.portfolioService) {
        window.portfolioService.markUnsaved();
    }
}

// Make renderCustomBlocks globally available
window.renderCustomBlocks = renderCustomBlocks;

/**
 * Download font files from Google Fonts
 */
async function downloadFont() {
    const fontFamily = document.getElementById('text-font-family')?.value;
    if (!fontFamily) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à—Ä–∏—Ñ—Ç');
        return;
    }
    
    // Fonts that are not from Google Fonts (system fonts)
    const systemFonts = ['Inter']; // Inter is often a system font
    
    if (systemFonts.includes(fontFamily)) {
        alert(`–®—Ä–∏—Ñ—Ç "${fontFamily}" —è–≤–ª—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–º –∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è. –û–Ω —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ.`);
        return;
    }
    
    try {
        // Open Google Fonts page for the selected font
        const fontUrl = `https://fonts.google.com/specimen/${fontFamily.replace(/\s+/g, '+')}`;
        window.open(fontUrl, '_blank');
        
        // Also show instructions
        setTimeout(() => {
            if (confirm(`–®—Ä–∏—Ñ—Ç "${fontFamily}" –æ—Ç–∫—Ä—ã—Ç –Ω–∞ Google Fonts.\n\n–î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:\n1. –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ Google Fonts –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "Download family"\n2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "Get embed code" –¥–ª—è –≤–µ–±-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è\n\n–û—Ç–∫—Ä—ã—Ç—å —Ç–∞–∫–∂–µ Google Fonts Helper –¥–ª—è –ø—Ä—è–º–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è?`)) {
                const helperUrl = `https://google-webfonts-helper.herokuapp.com/fonts/${fontFamily.toLowerCase().replace(/\s+/g, '-')}`;
                window.open(helperUrl, '_blank');
            }
        }, 500);
        
    } catch (error) {
        console.error('Error downloading font:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —à—Ä–∏—Ñ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞–π—Ç–∏ —à—Ä–∏—Ñ—Ç –≤—Ä—É—á–Ω—É—é –Ω–∞ fonts.google.com');
    }
}

// Make downloadFont globally available
window.downloadFont = downloadFont;

// Initialize custom blocks on page load
document.addEventListener('DOMContentLoaded', function() {
    // Handle image preview in modal
    const imageInput = document.getElementById('custom-block-image');
    if (imageInput) {
        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('custom-block-image-preview');
                    if (preview) {
                        preview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="max-w-full h-32 object-cover rounded border border-gray-300">`;
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Sync color picker and text input for background color
    const bgColorInput = document.getElementById('custom-block-bg-color');
    const bgColorText = document.getElementById('custom-block-bg-color-text');
    if (bgColorInput && bgColorText) {
        bgColorInput.addEventListener('input', function() {
            bgColorText.value = this.value;
            updateCustomBlockBgColorPreview();
            updatePreview();
        });
        bgColorText.addEventListener('input', function() {
            updateCustomBlockBgColorFromText();
            updatePreview();
        });
    }
});
</script>
{% endblock %}

